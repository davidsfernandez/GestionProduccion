# Diseño de Sprint 1: Infraestructura y Autenticación

## Objetivo
Implementar la base de seguridad persistente y el flujo de recuperación de contraseña, además de preparar el despliegue automatizado.

## Tareas Detalladas
1. **Modelado de Datos (Backend):**
   - Entidad `UserRefreshToken` para sesiones múltiples y persistentes.
   - Entidad `PasswordResetToken` para recuperación segura.
   - Configuración en `AppDbContext` (Fluent API).

2. **Servicios de Identidad (API):**
   - Refactorización de `AuthController` (Login con Refresh Token).
   - Endpoints de recuperación de contraseña (Forgot/Reset).
   - Lógica de revocación de sesiones.

3. **Cliente Blazor (Frontend):**
   - Implementación de `LocalStorage` en `CustomAuthStateProvider`.
   - Lógica de "Silent Refresh" para renovar tokens automáticamente antes de expirar.
   - UI de recuperación de contraseña (`ForgotPassword` y `ResetPassword`).

4. **Automatización (DevOps):**
   - Script de PowerShell para publicación e instalación en IIS (Windows).

## Criterios de Aceptación
- La sesión sobrevive al cierre del navegador.
- El token se renueva sin intervención del usuario.
- El flujo de cambio de clave es funcional y seguro.
- Publicación automatizada exitosa mediante script.

Módulo: Infraestructura, Seguridad y Despliegue.
  Objetivo: Implementar la base de autenticación persistente, el flujo de recuperación de contraseña y el andamiaje de instalación para el        
  cliente.

  1. Definición de Tareas Técnicas


   * T1.1: Persistencia de Tokens (Capa de Datos):
       * Entidad `UserRefreshToken`: Relación 1:N con User. Campos: Token (String/Guid), Expires (DateTime), Created (DateTime), CreatedByIp      
         (String), Revoked (DateTime?), RevokedByIp (String), ReplacedByToken (String).
       * Entidad `PasswordResetToken`: Relación 1:1 con User. Campos: TokenHash (String), ExpiryDate (DateTime), IsUsed (Bool).
       * Configuración Fluent API: Índices únicos para los tokens y borrado en cascada limitado para proteger la integridad del usuario.


   * T1.2: Motor de Autenticación Progresiva (API):
       * Refactorización de `AuthController`:
           * Modificar el método Login para generar el par (Access/Refresh).
           * Implementar Refresh-Token: Endpoint que valida el Refresh Token contra la base de datos y emite un nuevo set si es válido y no ha    
             expirado.
           * Implementar Revoke-Token: Endpoint para cerrar sesión de forma remota invalidando el Refresh Token.
           * Implementar Forgot-Password: Generación de token, almacenamiento del hash y simulación de envío (logeo de URL).
           * Implementar Reset-Password: Recepción de token + nueva clave, validación y actualización de PasswordHash.

   * T1.3: Intercepción y Persistencia (Cliente Blazor):
       * Integración de `Blazored.LocalStorage`: Sustitución de SessionStorage por LocalStorage en el CustomAuthStateProvider.
       * Lógica de Renovación Silenciosa: Al realizar cualquier petición HTTP (vía Interceptor o Handler), si el Access Token está a menos de 60
         segundos de expirar, el cliente dispara automáticamente la petición de Refresh-Token al backend antes de continuar con la petición
         original.
       * Sincronización de Estado: Asegurar que al refrescar la página (F5), el GetAuthenticationStateAsync recupere los tokens del LocalStorage y
         reconstruya el ClaimsPrincipal sin intervención del usuario.


   * T1.4: UI de Autoservicio de Seguridad:
       * Página `ForgotPassword.razor`: Formulario de recuperación.
       * Página `ResetPassword.razor`: Formulario de cambio de clave con parámetros de ruta (token).
       * Validaciones: Fortaleza de contraseña (Mayúsculas, números, longitud) y coincidencia de campos.


   * T1.5: Despliegue Automatizado (DevOps Local):
       * Script `Install-ERP.ps1`:
           * Verificación de entorno (.NET SDK/Runtime).
           * Comando dotnet publish optimizado.
           * Configuración automática de web.config para IIS.
           * Permisos de escritura en carpetas de uploads (necesario para el Módulo de Calidad futuro).


  2. Criterios de Aceptación (Definición de Hecho)
   1. El usuario permanece logueado tras cerrar y abrir el navegador.
   2. El token se refresca automáticamente sin interrumpir la experiencia del usuario.
   3. El flujo de recuperación de contraseña funciona de inicio a fin (solicitud -> cambio -> nuevo login).
   4. El script de instalación genera un paquete listo para IIS sin configuraciones manuales complejas.