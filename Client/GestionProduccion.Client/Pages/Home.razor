@page "/"
@using System.Net.Http.Json
@using System.Text.Json
@using GestionProduccion.Models.DTOs
@using GestionProduccion.Client.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject HttpClient Http
@inject NavigationManager NavigationManager
@inject SignalRService SignalR
@inject IJSRuntime JSRuntime
@inject JsonSerializerOptions JsonOptions
@implements IAsyncDisposable

@using GestionProduccion.Client.Resources

<PageTitle>@Portuguese.Dash_Title</PageTitle>

<div class="@(isTvMode ? "tv-mode-active" : "")">
    <div class="container-fluid p-0 animate-fade-in">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
            <h3 class="text-dark mb-0">@Portuguese.Dash_Title</h3>
            <div class="d-flex gap-2 w-100 w-md-auto">
                 <button class="btn btn-outline-primary shadow-sm flex-grow-1 flex-md-grow-0" @onclick="ToggleTvMode" title="@Portuguese.Dash_TvMode">
                     <i class="fa-solid fa-tv me-2"></i> <span class="d-none d-md-inline">@Portuguese.Dash_TvMode</span>
                 </button>
                 <button class="btn btn-primary shadow-sm" @onclick="LoadDashboard">
                     <i class="fa-solid fa-arrows-rotate"></i>
                 </button>
            </div>
        </div>

        @if (loading && dashboard == null)
        {
            <div class="d-flex justify-content-center mt-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">@Portuguese.Loading</span>
                </div>
            </div>
        }
        else if (dashboard != null)
        {
            <!-- FINANCIAL CARDS (ADMIN ONLY) -->
            <AuthorizeView Roles="Administrator">
                <div class="row mb-4">
                    <div class="col-12 col-sm-6 col-xxl-3 d-flex">
                        <div class="card flex-fill border-0 shadow-sm animate-fade-in-up delay-1">
                            <div class="card-body py-4">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <h3 class="mb-2 fw-bold text-dark">R$ @dashboard.MonthAverageCostPerPiece.ToString("N2")</h3>
                                        <p class="mb-0 text-muted small fw-bold uppercase">Custo Médio / Peça</p>
                                    </div>
                                    <div class="d-inline-block ms-3">
                                        <div class="bg-primary-soft rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                                            <i class="fa-solid fa-coins text-primary fs-4"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-xxl-3 d-flex">
                        <div class="card flex-fill border-0 shadow-sm animate-fade-in-up delay-2">
                            <div class="card-body py-4">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <h3 class="mb-2 fw-bold @(dashboard.MonthAverageMargin < 0 ? "text-danger" : "text-success")">
                                            @dashboard.MonthAverageMargin.ToString("N1")%
                                        </h3>
                                        <p class="mb-0 text-muted small fw-bold uppercase">Margem Média</p>
                                    </div>
                                    <div class="d-inline-block ms-3">
                                        <div class="bg-success-soft rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                                            <i class="fa-solid fa-chart-pie text-success fs-4"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-xxl-3 d-flex">
                        <div class="card flex-fill border-0 shadow-sm animate-fade-in-up delay-3">
                            <div class="card-body py-4">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <h3 class="mb-2 fw-bold text-dark">@dashboard.MonthProductionQuantity</h3>
                                        <p class="mb-0 text-muted small fw-bold uppercase">Produção do Mês</p>
                                    </div>
                                    <div class="d-inline-block ms-3">
                                        <div class="bg-info-soft rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                                            <i class="fa-solid fa-industry text-info fs-4"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-xxl-3 d-flex">
                        <div class="card flex-fill border-0 shadow-sm animate-fade-in-up delay-4">
                            <div class="card-body py-4">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <h3 class="mb-2 fw-bold @(dashboard.DelayedOrdersCount > 0 ? "text-danger" : "text-success")">
                                            @dashboard.DelayedOrdersCount
                                        </h3>
                                        <p class="mb-0 text-muted small fw-bold uppercase">Ordens Atrasadas</p>
                                    </div>
                                    <div class="d-inline-block ms-3">
                                        <div class="bg-danger-soft rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                                            <i class="fa-solid fa-triangle-exclamation text-danger fs-4"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </AuthorizeView>

            <div class="row">
                <!-- COLUMNA PRINCIPAL (LEFT - Charts & Lists) -->
                <div class="col-xl-8 d-flex flex-column">

                    <!-- TOP PROFITABLE MODELS (ADMIN ONLY) -->
                    <AuthorizeView Roles="Administrator">
                        <div class="card flex-fill w-100 animate-fade-in-up delay-3 mb-4">
                            <div class="card-header border-0 pt-4 px-4 bg-success bg-opacity-10">
                                <h5 class="card-title mb-0 text-success">Modelos Mais Lucrativos (Top 5)</h5>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover my-0">
                                    <thead>
                                        <tr>
                                            <th>Modelo</th>
                                            <th class="text-end">Margem Média</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (dashboard.TopProfitableModels != null)
                                        {
                                            @foreach (var item in dashboard.TopProfitableModels)
                                            {
                                                <tr @key="item.Sku">
                                                    <td><strong>@item.Sku</strong> - @item.Name</td>
                                                    <td class="text-end text-success fw-bold">@item.AverageMargin.ToString("N1")%</td>
                                                </tr>
                                            }
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </AuthorizeView>

                    <!-- WORKSHOP PRODUCTION CHART -->
                    <div class="card flex-fill w-100 animate-fade-in-up delay-4">
                        <div class="card-header border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Produção por Oficina</h5>
                            <i class="fa-solid fa-chart-bar text-muted"></i>
                        </div>
                        <div class="card-body py-3">
                            <div class="chart chart-sm" style="height: 250px;">
                                <canvas id="workshopChart"></canvas>
                            </div>
                            @if (dashboard.ProductionByWorkshop == null || !dashboard.ProductionByWorkshop.Any())
                            {
                                <div class="text-center text-muted small mt-2">Sem dados de produção este mês.</div>
                            }
                        </div>
                    </div>
                </div>

                <!-- COLUMNA LATERAL (RIGHT - Alerts) -->
                <div class="col-xl-4 d-flex flex-column">

                    <!-- STALLED STOCK -->
                    <div class="card flex-fill animate-fade-in-up delay-2 mb-4">
                        <div class="card-header border-0 pt-4 px-4 bg-warning bg-opacity-10">
                            <h5 class="card-title mb-0 text-warning">Estoque Parado (> 60 dias)</h5>
                        </div>
                        <div class="card-body p-0">
                             <ul class="list-group list-group-flush">
                                @if (dashboard.StalledStock != null && dashboard.StalledStock.Any())
                                {
                                    @foreach (var item in dashboard.StalledStock)
                                    {
                                        <li @key="item.Sku" class="list-group-item border-0 px-4 py-3">
                                            <div class="d-flex align-items-center">
                                                <div class="bg-warning-soft rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                                    <i class="fa-solid fa-box-open text-warning"></i>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <strong class="text-dark d-block small fw-bold">@item.Sku</strong>
                                                    <small class="text-muted">@item.Name</small>
                                                </div>
                                            </div>
                                        </li>
                                    }
                                }
                                else
                                {
                                    <li class="p-4 text-center text-muted small fw-bold">Nenhum item parado. Ótimo!</li>
                                }
                            </ul>
                        </div>
                    </div>

                    <!-- MODELS TO DISCONTINUE (ADMIN) -->
                    <AuthorizeView Roles="Administrator">
                        <div class="card flex-fill animate-fade-in-up delay-1">
                            <div class="card-header border-0 pt-4 px-4 bg-danger bg-opacity-10">
                                <h5 class="card-title mb-0 text-danger">Atenção: Margem Baixa</h5>
                            </div>
                            <div class="card-body p-0">
                                <ul class="list-group list-group-flush">
                                                                    @if (dashboard.BottomProfitableModels != null && dashboard.BottomProfitableModels.Any(p => p.AverageMargin < 5)) // Threshold 5%
                                                                    {
                                                                        @foreach (var item in dashboard.BottomProfitableModels.Where(p => p.AverageMargin < 5))
                                                                        {
                                                                            <li @key="item.Sku" class="list-group-item border-0 px-4 py-3">
                                                                                <div class="d-flex align-items-center">                                                    <div class="bg-danger-soft rounded-circle d-flex align-items-center justify-content-center" style="width: 36px; height: 36px;">
                                                        <i class="fa-solid fa-arrow-trend-down text-danger"></i>
                                                    </div>
                                                    <div class="flex-grow-1 ms-3">
                                                        <strong class="text-danger d-block small fw-bold">@item.Sku</strong>
                                                        <small class="text-muted">Margem: @item.AverageMargin.ToString("N1")%</small>
                                                    </div>
                                                </div>
                                            </li>
                                        }
                                    }
                                    else
                                    {
                                        <div class="p-4 text-center text-muted">
                                            <i class="fa-solid fa-thumbs-up text-success fs-3 mb-2"></i>
                                            <p class="mb-0 small fw-bold">Todas as margens saudáveis.</p>
                                        </div>
                                    }
                                </ul>
                            </div>
                        </div>
                    </AuthorizeView>

                    <!-- PERFORMANCE RANKING (Gamification) -->
                    <div class="card flex-fill animate-fade-in-up delay-3">
                        <div class="card-header border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Ranking de Desempenho</h5>
                            <span class="badge bg-success-soft text-success">Top Operadores</span>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush">
                                @if (ranking != null && ranking.Any())
                                {
                                    @for (int i = 0; i < ranking.Count; i++)
                                    {
                                        var entry = ranking[i];
                                        <div class="list-group-item border-0 px-4 py-3">
                                            <div class="d-flex align-items-center">
                                                <div class="me-3 fw-bold text-muted" style="width: 20px;">@(i + 1)º</div>
                                                <img src="@(string.IsNullOrEmpty(entry.AvatarUrl) ? "/img/avatars/avatar.jpg" : entry.AvatarUrl)" 
                                                     class="rounded-circle me-3" width="36" height="36" alt="@entry.UserName">
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-0 small fw-bold">@entry.UserName</h6>
                                                    <small class="text-muted">@entry.CompletedTasks tarefas concluídas</small>
                                                </div>
                                                @if (i == 0) { <i class="fa-solid fa-medal text-warning fs-4"></i> }
                                                else if (i == 1) { <i class="fa-solid fa-medal text-secondary fs-4"></i> }
                                                else if (i == 2) { <i class="fa-solid fa-medal text-brown fs-4" style="color: #cd7f32;"></i> }
                                            </div>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="p-4 text-center text-muted small">Sem dados de ranking disponíveis.</div>
                                }
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        }
    </div>
</div>

@code {
    private DashboardCompleteResponse? dashboard;
    private List<RankingEntryDto>? ranking;
    private bool loading = false;
    private bool isTvMode = false;
    private System.Threading.Timer? _timer;

    protected override async Task OnInitializedAsync()
    {
        var hubUrl = NavigationManager.ToAbsoluteUri("/productionHub").ToString();
        await SignalR.StartConnection(hubUrl);

        SignalR.OnUpdateReceived += async (opId, stage, status) => {
            await LoadDashboard(); // Refresh on updates
            await InvokeAsync(StateHasChanged);
        };

        await LoadDashboard();
        await LoadRanking();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (dashboard != null && dashboard.ProductionByWorkshop != null && dashboard.ProductionByWorkshop.Any())
        {
            var labels = dashboard.ProductionByWorkshop.Select(x => x.WorkshopName).ToArray();
            var data = dashboard.ProductionByWorkshop.Select(x => x.Quantity).ToArray();
            await JSRuntime.InvokeVoidAsync("seronaCharts.renderBarChart", "workshopChart", data, labels);
        }
    }

    private async Task LoadDashboard()
    {
        try
        {
            if (dashboard == null) loading = true;
            // Use new endpoint with options
            dashboard = await Http.GetFromJsonAsync<DashboardCompleteResponse>("api/Dashboard/completo", JsonOptions);
            StateHasChanged();
        }
        catch (Exception)
        {
            // Error loading handled
        }
        finally
        {
            loading = false;
        }
    }

    private async Task LoadRanking()
    {
        try
        {
            var resp = await Http.GetFromJsonAsync<ApiResponse<List<RankingEntryDto>>>("api/Tasks/ranking", JsonOptions);
            if (resp != null && resp.Success)
            {
                ranking = resp.Data;
            }
        }
        catch { /* Silent fail */ }
    }

    private void ToggleTvMode()
    {
        isTvMode = !isTvMode;
        if (isTvMode)
        {
            StartAutoRefresh();
        }
        else
        {
            _timer?.Dispose();
            _timer = null;
        }
    }

    private void StartAutoRefresh()
    {
        _timer?.Dispose();
        _timer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await LoadDashboard();
                StateHasChanged();
            });
        }, null, 60000, 60000); // 1 min refresh for BI
    }

    public async ValueTask DisposeAsync()
    {
        _timer?.Dispose();
        await SignalR.StopConnection();
    }
}
