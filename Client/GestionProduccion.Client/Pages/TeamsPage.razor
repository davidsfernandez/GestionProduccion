@page "/equipes"
@using GestionProduccion.Models.DTOs
@using Microsoft.AspNetCore.Authorization
@using System.Text.Json
@attribute [Authorize(Roles = "Administrator,Leader")]
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@inject ToastService ToastService
@inject JsonSerializerOptions JsonOptions

<div class="container-fluid p-0">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="h3 text-dark">Gestão de Equipes</h3>
        <div>
            @if (!HasEligibleUsers && !loading)
            {
                <div class="alert alert-warning py-2 px-3 mb-0 d-inline-block me-3 small">
                    <i class="fa-solid fa-triangle-exclamation me-2"></i>
                    Não é possível criar equipes. Cadastre usuários com cargo Líder ou Operacional primeiro.
                </div>
            }
            <button class="btn btn-primary" @onclick="ShowCreateModal" disabled="@(!HasEligibleUsers)">
                <i class="fa-solid fa-plus me-2"></i>Adicionar Equipe
            </button>
        </div>
    </div>

    @if (loading)
    {
        <div class="d-flex justify-content-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
        </div>
    }
    else if (teams == null || teams.Count == 0)
    {
        <div class="alert alert-info">Nenhuma equipe encontrada.</div>
    }
    else
    {
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Nome da Equipe</th>
                                <th>Membros</th>
                                <th>Status</th>
                                <th class="text-end">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var team in teams)
                            {
                                <tr @key="team.Id">
                                    <td>@team.Name</td>
                                    <td>
                                        <span class="badge bg-info-soft text-info">@team.MemberCount</span>
                                    </td>
                                    <td>
                                        <span class="badge @(team.IsActive ? "bg-success" : "bg-danger")">
                                            @(team.IsActive ? "Ativo" : "Inativo")
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        <button class="btn btn-sm btn-light me-1" @onclick="() => EditTeam(team)" title="Editar">
                                            <i class="fa-solid fa-pen"></i>
                                        </button>
                                        <button class="btn btn-sm btn-light text-danger" @onclick="() => DeleteTeam(team)" title="Excluir">
                                            <i class="fa-solid fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

@if (showModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">@(isEditing ? "Editar Equipe" : "Nova Equipe")</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body p-4">
                    @if (!isEditing)
                    {
                        <p class="small text-muted mb-4">Selecione pelo menos um membro para criar a equipe.</p>
                    }
                    
                    <EditForm Model="createRequest" OnValidSubmit="HandleSubmit">
                        <DataAnnotationsValidator />
                        <ValidationSummary class="text-danger small mb-3" />

                        <div class="mb-4">
                            <label class="form-label fw-bold small">Nome da Equipe</label>
                            <InputText class="form-control form-control-lg" @bind-Value="createRequest.Name" placeholder="Ex: Equipe de Costura A" />
                            <ValidationMessage For="@(() => createRequest.Name)" class="text-danger small" />
                        </div>

                        <label class="form-label fw-bold small">Gerenciar Membros</label>
                        <div class="border rounded p-3 bg-light mb-3" style="max-height: 250px; overflow-y: auto;">
                            @if (eligibleUsers != null)
                            {
                                @foreach (var user in eligibleUsers)
                                {
                                    bool isChecked = isEditing 
                                        ? teamModel.SelectedUserIds.Contains(user.Id)
                                        : createRequest.InitialUserIds.Contains(user.Id);

                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="user-@user.Id" 
                                               checked="@isChecked"
                                               @onchange="@(e => OnUserToggled(user.Id, e))" />
                                        <label class="form-check-label small" for="user-@user.Id">
                                            @user.FullName <span class="text-muted">(@user.Role)</span>
                                        </label>
                                    </div>
                                }
                            }
                        </div>
                        <div class="small text-muted mt-1 mb-3">
                            @(isEditing ? teamModel.SelectedUserIds.Count : createRequest.InitialUserIds.Count) selecionado(s)
                        </div>

                        @if (isEditing)
                        {
                            <div class="form-check mb-3">
                                <InputCheckbox class="form-check-input" @bind-Value="teamModel.IsActive" id="activeCheck" />
                                <label class="form-check-label" for="activeCheck">Equipe Ativa</label>
                            </div>
                        }

                        <div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
                            <button type="button" class="btn btn-light px-4" @onclick="CloseModal">Cancelar</button>
                            <button type="submit" class="btn btn-primary px-4 shadow-sm" 
                                    disabled="@(isSaving || (isEditing && teamModel.SelectedUserIds.Count == 0) || (!isEditing && createRequest.InitialUserIds.Count == 0))">
                                @(isSaving ? "Salvando..." : "Salvar Equipe")
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<SewingTeamDto>? teams;
    private List<UserDto>? allUsers;
    private List<UserDto>? eligibleUsers;
    private CreateSewingTeamRequest createRequest = new();
    private SewingTeamDto teamModel = new();
    private bool showModal = false;
    private bool isEditing = false;
    private bool isSaving = false;
    private bool loading = true;

    private bool HasEligibleUsers => eligibleUsers?.Any() == true;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        loading = true;
        try 
        {
            var teamsTask = Http.GetFromJsonAsync<ApiResponse<List<SewingTeamDto>>>("api/SewingTeams", JsonOptions);
            var usersTask = Http.GetFromJsonAsync<List<UserDto>>("api/Users", JsonOptions);

            await Task.WhenAll(teamsTask, usersTask);

            var teamsResponse = await teamsTask;
            teams = teamsResponse?.Data;

            allUsers = await usersTask;
            eligibleUsers = allUsers?.Where(u => u.Role.ToString() == "Leader" || u.Role.ToString() == "Operational").ToList();
        }
        catch (Exception ex)
        {
            ToastService.ShowToast($"Erro ao carregar dados: {ex.Message}", ToastLevel.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private void ShowCreateModal()
    {
        createRequest = new CreateSewingTeamRequest();
        isEditing = false;
        showModal = true;
    }

    private void EditTeam(SewingTeamDto team)
    {
        // For editing, we load the team with its full member list to populate SelectedUserIds
        // However, the 'team' parameter here comes from the table list.
        // We'll fetch the detail to be safe and get current IDs.
        teamModel = new SewingTeamDto 
        { 
            Id = team.Id, 
            Name = team.Name, 
            IsActive = team.IsActive,
            SelectedUserIds = allUsers?.Where(u => u.SewingTeamId == team.Id).Select(u => u.Id).ToList() ?? new List<int>()
        };
        createRequest = new CreateSewingTeamRequest { Name = team.Name };
        isEditing = true;
        showModal = true;
    }

    private void CloseModal() => showModal = false;

    private void OnUserToggled(int userId, ChangeEventArgs e)
    {
        bool isChecked = (bool)(e.Value ?? false);
        if (isEditing)
        {
            if (isChecked)
            {
                if (!teamModel.SelectedUserIds.Contains(userId)) teamModel.SelectedUserIds.Add(userId);
            }
            else
            {
                teamModel.SelectedUserIds.Remove(userId);
            }
        }
        else
        {
            if (isChecked)
            {
                if (!createRequest.InitialUserIds.Contains(userId)) createRequest.InitialUserIds.Add(userId);
            }
            else
            {
                createRequest.InitialUserIds.Remove(userId);
            }
        }
    }

    private async Task HandleSubmit()
    {
        if (isSaving) return;
        try
        {
            isSaving = true;
            HttpResponseMessage response;
            
            if (isEditing)
            {
                response = await Http.PutAsJsonAsync($"api/SewingTeams/{teamModel.Id}", teamModel, JsonOptions);
            }
            else
            {
                response = await Http.PostAsJsonAsync("api/SewingTeams", createRequest, JsonOptions);
            }

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ApiResponse<SewingTeamDto>>(JsonOptions);
                if (result?.Data != null)
                {
                    await LoadData(); // Full reload to refresh member counts and eligible users
                }
                showModal = false;
                ToastService.ShowToast(isEditing ? "Membros da equipe atualizados" : "Equipe salva com sucesso", ToastLevel.Success);
            }
            else
            {
                var error = await response.Content.ReadFromJsonAsync<ApiResponse<string>>();
                ToastService.ShowToast(error?.Message ?? "Erro ao salvar equipe", ToastLevel.Error, "Erro de Negócio");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowToast($"Erro: {ex.Message}", ToastLevel.Error);
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task DeleteTeam(SewingTeamDto team)
    {
        var msg = "ATENÇÃO: Ao excluir esta equipe, todos os seus membros serão transferidos automaticamente para outras equipes ativas baseando-se na carga de trabalho. Deseja continuar?";
        
        if (await JSRuntime.InvokeAsync<bool>("confirm", msg))
        {
            try
            {
                var response = await Http.DeleteAsync($"api/SewingTeams/{team.Id}");
                if (response.IsSuccessStatusCode)
                {
                    await LoadData();
                    ToastService.ShowToast("Equipe excluída e membros reatribuídos", ToastLevel.Success);
                }
                else if (response.StatusCode == System.Net.HttpStatusCode.Conflict)
                {
                    var error = await response.Content.ReadFromJsonAsync<ApiResponse<string>>();
                    ToastService.ShowToast(error?.Message ?? "Erro: Não há outras equipes para receber os funcionários.", ToastLevel.Error, "Bloqueio de Reatribuição");
                }
                else
                {
                    ToastService.ShowToast("Erro ao excluir equipe", ToastLevel.Error);
                }
            }
            catch (Exception ex)
            {
                ToastService.ShowToast($"Erro: {ex.Message}", ToastLevel.Error);
            }
        }
    }
}
