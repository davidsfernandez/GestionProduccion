@page "/equipes"
@using GestionProduccion.Models.DTOs
@using Microsoft.AspNetCore.Authorization
@using System.Text.Json
@attribute [Authorize(Roles = "Administrator,Leader")]
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@inject ToastService ToastService

<div class="container-fluid p-0">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="h3 text-dark">Gestão de Equipes</h3>
        <button class="btn btn-primary" @onclick="ShowCreateModal">
            <i class="fa-solid fa-plus me-2"></i>Adicionar Equipe
        </button>
    </div>

    @if (teams == null)
    {
        <div class="d-flex justify-content-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
        </div>
    }
    else if (teams.Count == 0)
    {
        <div class="alert alert-info">Nenhuma equipe encontrada.</div>
    }
    else
    {
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Nome da Equipe</th>
                                <th>Status</th>
                                <th class="text-end">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var team in teams)
                            {
                                <tr @key="team.Id">
                                    <td>@team.Name</td>
                                    <td>
                                        <span class="badge @(team.IsActive ? "bg-success" : "bg-danger")">
                                            @(team.IsActive ? "Ativo" : "Inativo")
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => EditTeam(team)">Editar</button>
                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteTeam(team)">Excluir</button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

@if (showModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(isEditing ? "Editar Equipe" : "Nova Equipe")</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body p-4">
                    <EditForm Model="teamModel" OnValidSubmit="HandleSubmit">
                        <DataAnnotationsValidator />
                        <div class="mb-3">
                            <label class="form-label fw-bold">Nome da Equipe</label>
                            <InputText class="form-control" @bind-Value="teamModel.Name" placeholder="Ex: Equipe A" />
                            <ValidationMessage For="@(() => teamModel.Name)" class="text-danger small" />
                        </div>
                        <div class="mb-3 form-check">
                            <InputCheckbox class="form-check-input" @bind-Value="teamModel.IsActive" id="activeCheck" />
                            <label class="form-check-label" for="activeCheck">Ativo</label>
                        </div>
                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <button type="button" class="btn btn-light" @onclick="CloseModal">Cancelar</button>
                            <button type="submit" class="btn btn-primary" disabled="@isSaving">
                                @(isSaving ? "Salvando..." : "Salvar")
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<SewingTeamDto>? teams;
    private SewingTeamDto teamModel = new();
    private bool showModal = false;
    private bool isEditing = false;
    private bool isSaving = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadTeams();
    }

    private async Task LoadTeams()
    {
        try 
        {
            var response = await Http.GetFromJsonAsync<ApiResponse<List<SewingTeamDto>>>("api/SewingTeams");
            teams = response?.Data;
        }
        catch (Exception ex)
        {
            ToastService.ShowToast($"Erro ao carregar: {ex.Message}", ToastLevel.Error);
        }
    }

    private void ShowCreateModal()
    {
        teamModel = new SewingTeamDto { IsActive = true };
        isEditing = false;
        showModal = true;
    }

    private void EditTeam(SewingTeamDto team)
    {
        teamModel = new SewingTeamDto { Id = team.Id, Name = team.Name, IsActive = team.IsActive };
        isEditing = true;
        showModal = true;
    }

    private void CloseModal() => showModal = false;

    private async Task HandleSubmit()
    {
        if (isSaving) return;
        try
        {
            isSaving = true;
            HttpResponseMessage response;
            if (isEditing)
                response = await Http.PutAsJsonAsync($"api/SewingTeams/{teamModel.Id}", teamModel);
            else
                response = await Http.PostAsJsonAsync("api/SewingTeams", teamModel);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ApiResponse<SewingTeamDto>>();
                if (result?.Data != null)
                {
                    if (isEditing)
                    {
                        var index = teams?.FindIndex(t => t.Id == result.Data.Id) ?? -1;
                        if (index != -1) teams![index] = result.Data;
                    }
                    else
                    {
                        teams?.Add(result.Data);
                    }
                }
                showModal = false;
                ToastService.ShowToast("Equipe salva com sucesso", ToastLevel.Success);
                StateHasChanged();
            }
            else
            {
                var error = await response.Content.ReadFromJsonAsync<ApiResponse<string>>();
                ToastService.ShowToast(error?.Message ?? "Erro ao salvar equipe", ToastLevel.Error);
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowToast($"Erro: {ex.Message}", ToastLevel.Error);
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task DeleteTeam(SewingTeamDto team)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", $"Deseja excluir esta equipe ({team.Name})?"))
        {
            try
            {
                var response = await Http.DeleteAsync($"api/SewingTeams/{team.Id}");
                if (response.IsSuccessStatusCode)
                {
                    teams?.Remove(team);
                    ToastService.ShowToast("Equipe excluída", ToastLevel.Success);
                    StateHasChanged();
                }
                else if (response.StatusCode == System.Net.HttpStatusCode.Conflict)
                {
                    var error = await response.Content.ReadFromJsonAsync<ApiResponse<string>>();
                    ToastService.ShowToast(error?.Message ?? "Conflito ao excluir", ToastLevel.Error);
                }
                else
                {
                    ToastService.ShowToast("Erro ao excluir equipe", ToastLevel.Error);
                }
            }
            catch (Exception ex)
            {
                ToastService.ShowToast($"Erro: {ex.Message}", ToastLevel.Error);
            }
        }
    }
}
