@page "/orders/{Id:int}"
@using GestionProduccion.Client.Models.DTOs
@using Microsoft.AspNetCore.Authorization
@using System.Text.Json
@using System.Text.Json.Serialization
@attribute [Authorize]
@using GestionProduccion.Client.Services
@inject HttpClient Http
@inject NavigationManager NavigationManager
@inject ToastService ToastService

@using GestionProduccion.Client.Resources

<PageTitle>@Portuguese.OP_Details_Title - @order?.UniqueCode</PageTitle>

<div class="container-fluid p-0 animate-fade-in">
    @if (loading)
    {
        <div class="d-flex justify-content-center mt-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">@Portuguese.Loading</span>
            </div>
        </div>
    }
    else if (order == null)
    {
        <div class="alert alert-danger rounded-4 shadow-sm">@Portuguese.OP_OrderNotFound</div>
        <button class="btn btn-secondary shadow-sm" @onclick="GoBack">@Portuguese.OP_BackToList</button>
    }
    else
    {
        <div class="row mb-2 mb-xl-3 align-items-center">
            <div class="col-auto">
                <button class="btn btn-light shadow-sm me-3" @onclick="GoBack">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <h3 class="d-inline-block align-middle text-dark mb-0">Ordem: @order.UniqueCode</h3>
            </div>
            <div class="col-auto ms-auto">
                <span class="badge @GetStatusSoftClass(order.CurrentStatus) fs-sm px-3 py-2">
                    @TranslateStatus(order.CurrentStatus)
                </span>
            </div>
        </div>

        <div class="row">
            <!-- Order Info -->
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header border-0 pt-4 px-4">
                        <h5 class="card-title mb-0">InformaÃ§Ãµes Detalhadas</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="row">
                            <div class="col-sm-6 mb-4">
                                <label class="form-label small fw-bold text-muted d-block uppercase mb-1">Produto</label>
                                <div class="text-dark fw-bold">@order.ProductDescription</div>
                            </div>
                            <div class="col-sm-3 mb-4">
                                <label class="form-label small fw-bold text-muted d-block uppercase mb-1">Quantidade</label>
                                <div class="text-dark fw-bold">@order.Quantity unidades</div>
                            </div>
                            <div class="col-sm-3 mb-4">
                                <label class="form-label small fw-bold text-muted d-block uppercase mb-1">Etapa Atual</label>
                                <span class="badge bg-primary-soft">@TranslateStage(order.CurrentStage)</span>
                            </div>
                            <div class="col-sm-6 mb-4">
                                <label class="form-label small fw-bold text-muted d-block uppercase mb-1">Data de CriaÃ§Ã£o</label>
                                <div class="text-muted small">@order.CreationDate.ToString("f")</div>
                            </div>
                            <div class="col-sm-6 mb-4">
                                <label class="form-label small fw-bold text-muted d-block uppercase mb-1">Entrega Estimada</label>
                                <div class="text-primary fw-bold">@order.EstimatedDeliveryDate.ToLongDateString()</div>
                            </div>
                            <div class="col-12">
                                <label class="form-label small fw-bold text-muted d-block uppercase mb-1">ResponsÃ¡vel</label>
                                <div class="d-flex align-items-center flex-wrap gap-3 mt-2">
                                    <div class="d-flex align-items-center bg-light px-3 py-2 rounded-3">
                                        <div class="bg-white rounded-circle d-flex align-items-center justify-content-center me-2 shadow-sm" style="width: 32px; height: 32px;">
                                            <i class="fa-solid fa-user text-primary small"></i>
                                        </div>
                                        <span class="text-dark small fw-bold">@(order.AssignedUserName ?? Portuguese.OP_Unassigned)</span>
                                    </div>

                                    <AuthorizeView Roles="Administrator,Leader" Context="authContext">
                                        <div class="input-group input-group-sm w-auto shadow-sm" style="border-radius: 10px; overflow: hidden;">
                                            <select class="form-select border-0 bg-white" @onchange="OnUserSelected" style="min-width: 200px;">
                                                <option value="">@Portuguese.OP_ChangeAssignment</option>
                                                @if (assignableUsers != null)
                                                {
                                                    @foreach (var user in assignableUsers)
                                                    {
                                                        <option value="@user.Id" selected="@(user.Id == order.UserId)">@user.Name (@TranslateRole(user.Role))</option>
                                                    }
                                                }
                                            </select>
                                            <button class="btn btn-primary px-3" @onclick="AssignUser" disabled="@(selectedUserId == 0 || isAssigning)">
                                                @if (isAssigning)
                                                {
                                                    <span class="spinner-border spinner-border-sm"></span>
                                                }
                                                else
                                                {
                                                    <i class="fa-solid fa-check"></i>
                                                }
                                            </button>
                                        </div>
                                    </AuthorizeView>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Financial Analysis (Admin Only) -->
                <AuthorizeView Roles="Administrator" Context="financialContext">
                    @if (order.CalculatedTotalCost > 0)
                    {
                        <div class="card mb-4 bg-light border-primary border-opacity-25">
                            <div class="card-header border-0 pt-4 px-4 bg-transparent">
                                <h5 class="card-title mb-0 text-primary">Análise Financeira</h5>
                            </div>
                            <div class="card-body p-4">
                                <div class="row text-center">
                                    <div class="col-md-4 mb-3 mb-md-0 border-end">
                                        <div class="text-muted small uppercase mb-1">Custo Total</div>
                                        <div class="h3 mb-0 text-dark">R$ @order.CalculatedTotalCost.ToString("N2")</div>
                                    </div>
                                    <div class="col-md-4 mb-3 mb-md-0 border-end">
                                        <div class="text-muted small uppercase mb-1">Custo / Peça</div>
                                        <div class="h3 mb-0 text-dark">R$ @order.AverageCostPerPiece.ToString("N2")</div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-muted small uppercase mb-1">Margem</div>
                                        <div class="h3 mb-0 @(order.EstimatedProfitMargin < 0 ? "text-danger" : "text-success")">
                                            @order.EstimatedProfitMargin.ToString("N1")%
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </AuthorizeView>

                <!-- Actions Card -->
                <AuthorizeView Roles="Administrator,Leader,Operator" Context="actionContext">
                    <div class="card mb-4 overflow-hidden">
                        <div class="card-header border-0 pt-4 px-4 bg-light bg-opacity-50">
                            <h5 class="card-title mb-0">Controles de ProduÃ§Ã£o</h5>
                        </div>
                        <div class="card-body p-4">
                            <div class="d-flex flex-wrap gap-3">
                                <button class="btn btn-primary px-4 shadow-sm" @onclick="AdvanceStage"
                                        disabled="@(order.CurrentStage == "Packaging" || order.CurrentStatus == "Completed")">
                                    <i class="fa-solid fa-forward-step me-2"></i> @Portuguese.OP_AdvanceStage
                                </button>

                                @if (order.CurrentStatus == "Stopped")
                                {
                                    <button class="btn btn-success px-4 shadow-sm" @onclick="ResumeOrder">
                                        <i class="fa-solid fa-play me-2"></i> @Portuguese.OP_ResumeProduction
                                    </button>
                                }
                                else if (order.CurrentStatus != "Completed")
                                {
                                    <button class="btn btn-danger px-4 shadow-sm" @onclick="StopOrder">
                                        <i class="fa-solid fa-pause me-2"></i> @Portuguese.OP_StopProduction
                                    </button>
                                }

                                @if (order.CurrentStage == "Packaging" && order.CurrentStatus != "Completed")
                                {
                                    <AuthorizeView Roles="Administrator,Leader" Context="completeContext">
                                        <button class="btn btn-dark px-4 shadow-sm" @onclick="ShowCompleteModal">
                                            <i class="fa-solid fa-check-double me-2"></i> @Portuguese.OP_MarkCompleted
                                        </button>
                                    </AuthorizeView>
                                }
                            </div>
                        </div>
                    </div>
                </AuthorizeView>

                <!-- Change Stage / Rework -->
                <AuthorizeView Roles="Administrator,Leader,Operator" Context="changeStageContext">
                    <div class="card mb-4">
                        <div class="card-header border-0 pt-4 px-4 bg-warning bg-opacity-10">
                            <h5 class="card-title mb-0">Alterar EstÃ¡gio / Retrabalho</h5>
                        </div>
                        <div class="card-body p-4">
                            <div class="row align-items-end">
                                <div class="col-md-5 mb-3 mb-md-0">
                                    <label class="form-label small fw-bold text-muted">Novo EstÃ¡gio</label>
                                    <select class="form-select" @bind="targetStage">
                                        <option value="0">@Portuguese.Stage_Cutting</option>
                                        <option value="1">@Portuguese.Stage_Sewing</option>
                                        <option value="2">@Portuguese.Stage_Review</option>
                                        <option value="3">@Portuguese.Stage_Packaging</option>
                                    </select>
                                </div>
                                <div class="col-md-7">
                                    <label class="form-label small fw-bold text-muted">
                                        Motivo / ObservaÃ§Ã£o
                                        @if (IsRework) { <span class="text-danger">*</span> }
                                    </label>
                                    <div class="input-group">
                                        <input type="text" class="form-control @(IsRework && string.IsNullOrWhiteSpace(stageChangeNote) ? "is-invalid" : "")"
                                               placeholder="Descreva o motivo..."
                                               @bind="stageChangeNote" @bind:event="oninput" />
                                        <button class="btn btn-warning" @onclick="ChangeStage"
                                                disabled="@(!CanSaveStageChange || isChangingStage)">
                                            @if (isChangingStage)
                                            {
                                                <span class="spinner-border spinner-border-sm"></span>
                                            }
                                            else
                                            {
                                                <i class="fa-solid fa-rotate-left me-2"></i> <span>Atualizar</span>
                                            }
                                        </button>
                                    </div>
                                    @if (IsRework && string.IsNullOrWhiteSpace(stageChangeNote))
                                    {
                                        <div class="text-danger xsmall mt-1">ObrigatÃ³rio para retornar a uma fase anterior.</div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </AuthorizeView>

                                <!-- History and QA Tabs -->
                                <div class="card">
                                    <div class="card-header border-0 pt-4 px-4 bg-white">
                                        <ul class="nav nav-tabs card-header-tabs" id="orderTabs" role="tablist">
                                            <li class="nav-item">
                                                <button class="nav-link @(activeTab == "history" ? "active" : "")" @onclick='() => activeTab = "history"'>Histórico</button>
                                            </li>
                                            <li class="nav-item">
                                                <button class="nav-link @(activeTab == "qa" ? "active" : "")" @onclick='() => activeTab = "qa"'>
                                                    Qualidade (QA) 
                                                    @if(defects?.Any() == true) { <span class="badge bg-danger ms-1">@defects.Count</span> }
                                                </button>
                                            </li>
                                        </ul>
                                    </div>
                                    
                                    <div class="card-body p-0">
                                        @if (activeTab == "history")
                                        {
                                            <div class="table-responsive">
                                                <table class="table table-hover my-0">
                                                    <thead>
                                                        <tr>
                                                            <th class="text-nowrap">@Portuguese.Hist_Date</th>
                                                            <th class="text-nowrap">AÃ§Ã£o</th>
                                                            <th class="text-nowrap">ResponsÃ¡vel</th>
                                                            <th class="text-nowrap">Nota</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @if (history != null)
                                                        {
                                                            @foreach (var log in history.OrderByDescending(h => h.ModificationDate))
                                                            {
                                                                <tr>
                                                                    <td class="small text-muted text-nowrap">@log.ModificationDate.ToString("g")</td>    
                                                                    <td class="text-nowrap">
                                                                        <div class="d-flex align-items-center">
                                                                            <span class="badge bg-light text-muted border me-2 xsmall">@TranslateStage(log.PreviousStage)</span>
                                                                            <i class="fa-solid fa-arrow-right text-primary opacity-25 me-2 xsmall"></i>  
                                                                            <span class="badge bg-primary-soft xsmall">@TranslateStage(log.NewStage)</span>
                                                                        </div>
                                                                    </td>
                                                                    <td class="small text-nowrap">@log.UserName</td>
                                                                    <td class="small text-muted">@log.Note</td>
                                                                </tr>
                                                            }
                                                        }
                                                    </tbody>
                                                </table>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="p-4">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <h6 class="fw-bold mb-0">Defeitos Registrados</h6>
                                                    <AuthorizeView Roles="Administrator,Leader">
                                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => showQAForm = true">
                                                            <i class="fa-solid fa-bug me-1"></i> Reportar Defeito
                                                        </button>
                                                    </AuthorizeView>
                                                </div>
                
                                                @if (defects == null || !defects.Any())
                                                {
                                                    <div class="text-center py-4 text-muted">
                                                        <i class="fa-solid fa-shield-check fs-1 mb-2 opacity-25"></i>
                                                        <p class="small mb-0">Nenhum defeito registrado nesta ordem.</p>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="table-responsive">
                                                        <table class="table table-sm small">
                                                            <thead>
                                                                <tr>
                                                                    <th>Data</th>
                                                                    <th>Motivo</th>
                                                                    <th>Qtd</th>
                                                                    <th>Foto</th>
                                                                    <th>Ações</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                @foreach (var defect in defects)
                                                                {
                                                                    <tr>
                                                                        <td>@defect.RegistrationDate.ToString("dd/MM HH:mm")</td>
                                                                        <td>@defect.Reason</td>
                                                                        <td><span class="badge bg-danger-soft text-danger">@defect.Quantity</span></td>
                                                                        <td>
                                                                            @if (!string.IsNullOrEmpty(defect.PhotoUrl))
                                                                            {
                                                                                <button class="btn btn-link btn-sm p-0" @onclick="() => ViewPhoto(defect.PhotoUrl)">Ver</button>
                                                                            }
                                                                            else { <span>-</span> }
                                                                        </td>
                                                                        <td>
                                                                            <AuthorizeView Roles="Administrator,Leader">
                                                                                <button class="btn btn-link text-danger btn-sm p-0" @onclick="() => DeleteDefect(defect.Id)"><i class="fa-solid fa-trash"></i></button>
                                                                            </AuthorizeView>
                                                                        </td>
                                                                    </tr>
                                                                }
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
            <!-- Right Sidebar -->
            <div class="col-md-4">
                <div class="alert bg-primary-soft border-0 rounded-4 p-4 shadow-sm mb-4">
                    <h6 class="fw-bold text-primary mb-3"><i class="fa-solid fa-circle-info me-2"></i> @Portuguese.OP_WorkflowTip</h6>
                    <p class="small mb-0 text-muted" style="line-height: 1.6;">@Portuguese.OP_WorkflowDesc</p>
                </div>

                <div class="card">
                    <div class="card-header border-0 pt-4 px-4">
                        <h5 class="card-title mb-0">Atalhos RÃ¡pidos</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-light w-100 mb-2 text-start px-3 py-2 border shadow-none" @onclick="() => DownloadOrderReport(order.Id)">
                            <i class="fa-solid fa-file-pdf text-danger me-2"></i> Gerar RelatÃ³rio PDF
                        </button>
                        <button class="btn btn-primary w-100 text-start px-3 py-2 border shadow-none" @onclick="DownloadPdf">
                            <i class="fa-solid fa-print me-2"></i> Imprimir Ficha
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@if (showQAForm)
{
    <GestionProduccion.Client.Components.QARegistryModal 
        OrderId="Id" 
        OnSuccess="HandleDataLoaded" 
        OnClose="() => showQAForm = false" />
}

@if (showCompleteModal)
{
    <div class="modal fade show" style="display: block; background-color: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Finalização</h5>
                    <button type="button" class="btn-close" @onclick="CloseCompleteModal"></button>
                </div>
                <div class="modal-body">
                    <p>Tem certeza que deseja finalizar a produção da ordem <strong>@order?.UniqueCode</strong>?</p>
                    <p>Esta ação irá:</p>
                    <ul>
                        <li>Encerrar o cronômetro de produção.</li>
                        <li>Calcular os custos finais com base no tempo decorrido.</li>
                        <li>Atualizar o estoque.</li>
                    </ul>
                    <div class="alert alert-warning">
                        <strong>Quantidade:</strong> @order?.Quantity unidades
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseCompleteModal">Cancelar</button>
                    <button type="button" class="btn btn-success" @onclick="ConfirmCompleteOrder">Confirmar e Finalizar</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int Id { get; set; }
    private ProductionOrderDto? order;
    private List<ProductionHistoryDto>? history;
    private List<UserDto>? assignableUsers;
    private bool loading = true;
    private bool isAssigning = false;
    private int selectedUserId;
    private int targetStage;
    private string stageChangeNote = "";
    private bool isChangingStage = false;
    private bool showCompleteModal = false;

    private void ShowCompleteModal()
    {
        showCompleteModal = true;
    }

    private void CloseCompleteModal()
    {
        showCompleteModal = false;
    }

    private async Task ConfirmCompleteOrder()
    {
        showCompleteModal = false;
        var request = new { NewStatus = "Completed", Note = "Produto finalizado e pronto" };
        var response = await Http.PatchAsJsonAsync($"api/ProductionOrders/{Id}/status", request);
        if (response.IsSuccessStatusCode)
        {
            ToastService.ShowToast(Portuguese.Status_Completed, ToastLevel.Success);
            await LoadData();
        }
    }

    private async Task DownloadPdf()
    {
        if (order == null) return;

        try
        {
            ToastService.ShowToast("Gerando PDF...", ToastLevel.Info);

            var response = await Http.GetAsync($"api/ProductionOrders/{Id}/pdf");
            if (response.IsSuccessStatusCode)
            {
                var fileStream = await response.Content.ReadAsStreamAsync();
                using var streamRef = new DotNetStreamReference(stream: fileStream);

                await JSRuntime.InvokeVoidAsync("downloadFileFromStream", $"Orden_{order.UniqueCode}.pdf", streamRef);
                ToastService.ShowToast("Download iniciado!", ToastLevel.Success);
            }
            else
            {
                ToastService.ShowToast("Erro ao gerar PDF", ToastLevel.Error);
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowToast($"Erro: {ex.Message}", ToastLevel.Error);
        }
    }

    private static JsonSerializerOptions _jsonOptions = new JsonSerializerOptions
    {
        PropertyNameCaseInsensitive = true,
        Converters = { new JsonStringEnumConverter() }
    };

    private string activeTab = "history";
    private List<QADefectDto>? defects;
    private bool showQAForm = false;
    private string? selectedPhotoUrl;

    private async Task ViewPhoto(string url)
    {
        selectedPhotoUrl = url;
        await JSRuntime.InvokeVoidAsync("bootstrap.Modal.getOrCreateInstance", "#photoModal.show");
    }

    private async Task DeleteDefect(int id)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "Deseja excluir este registro de defeito?"))
        {
            var response = await Http.DeleteAsync($"api/QA/{id}");
            if (response.IsSuccessStatusCode)
            {
                await LoadDefects();
                ToastService.ShowToast("Defeito removido", ToastLevel.Success);
            }
        }
    }

    private async Task LoadDefects()
    {
        try
        {
            var resp = await Http.GetFromJsonAsync<ApiResponse<List<QADefectDto>>>($"api/QA/order/{Id}");
            if (resp != null && resp.Success)
            {
                defects = resp.Data;
            }
        }
        catch { /* Silent fail */ }
    }

    private async Task HandleDataLoaded()
    {
        await LoadDefects();
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        await LoadAssignableUsers();
        await LoadDefects();
    }

    private async Task LoadData()
    {
        try
        {
            loading = true;
            var orderResp = await Http.GetAsync($"api/ProductionOrders/{Id}");
            if (orderResp.IsSuccessStatusCode)
            {
                var content = await orderResp.Content.ReadAsStringAsync();
                order = JsonSerializer.Deserialize<ProductionOrderDto>(content, _jsonOptions);
                targetStage = GetStageIndex(order.CurrentStage);
                stageChangeNote = "";
            }

            var historyResp = await Http.GetAsync($"api/ProductionOrders/{Id}/history");
            if (historyResp.IsSuccessStatusCode)
            {
                var content = await historyResp.Content.ReadAsStringAsync();
                history = JsonSerializer.Deserialize<List<ProductionHistoryDto>>(content, _jsonOptions);
            }
        }
        catch (Exception)
        {
            // Error handling handled via loading state and order being null
        }
        finally
        {
            loading = false;
        }
    }

    private async Task LoadAssignableUsers()
    {
        try
        {
            var response = await Http.GetAsync("api/ProductionOrders/assignable");
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                assignableUsers = JsonSerializer.Deserialize<List<UserDto>>(content, _jsonOptions);
            }
        }
        catch (Exception)
        {
            // Silent failure
        }
    }

    private void OnUserSelected(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var userId))
        {
            selectedUserId = userId;
        }
        else
        {
            selectedUserId = 0;
        }
    }

    private string TranslateStage(string? stage) => stage?.ToLower() switch
    {
        "cutting" => Portuguese.Stage_Cutting,
        "sewing" => Portuguese.Stage_Sewing,
        "review" => Portuguese.Stage_Review,
        "packaging" => Portuguese.Stage_Packaging,
        _ => stage ?? ""
    };

    private string TranslateStatus(string? status) => status?.ToLower() switch
    {
        "inproduction" => Portuguese.Status_InProduction,
        "stopped" => Portuguese.Status_Stopped,
        "completed" => Portuguese.Status_Completed,
        "paused" => Portuguese.Status_Paused,
        "finished" => Portuguese.Status_Finished,
        _ => status ?? ""
    };

    private string TranslateRole(UserRole role) => role switch
    {
        UserRole.Administrator => Portuguese.Role_Admin,
        UserRole.Leader => Portuguese.Role_Leader,
        UserRole.Operator => Portuguese.Role_Operator,
        UserRole.Sewer => Portuguese.Role_Operator, // Legacy mapping
        UserRole.Workshop => Portuguese.Role_Workshop,
        _ => role.ToString()
    };

    private async Task AssignUser()
    {
        if (selectedUserId == 0) return;

        try
        {
            isAssigning = true;
            var response = await Http.PostAsJsonAsync($"api/ProductionOrders/{Id}/assign", new { UserId = selectedUserId });

            if (response.IsSuccessStatusCode)
            {
                ToastService.ShowToast(Portuguese.Msg_TaskAssigned, ToastLevel.Success);
                await LoadData();
            }
        }
        catch (Exception)
        {
            // Silent error
        }
        finally
        {
            isAssigning = false;
        }
    }

    private async Task AdvanceStage()
    {
        var response = await Http.PostAsync($"api/ProductionOrders/{Id}/advance-stage", null);
        if (response.IsSuccessStatusCode)
        {
            ToastService.ShowToast(Portuguese.Msg_StageAdvanced, ToastLevel.Success);
            await LoadData();
        }
    }

    private async Task StopOrder()
    {
        var request = new { NewStatus = "Stopped", Note = "Ordem parada manualmente" };
        var response = await Http.PatchAsJsonAsync($"api/ProductionOrders/{Id}/status", request);
        if (response.IsSuccessStatusCode)
        {
            ToastService.ShowToast(Portuguese.Msg_StatusUpdated, ToastLevel.Warning);
            await LoadData();
        }
    }

    private async Task ResumeOrder()
    {
        var request = new { NewStatus = "InProduction", Note = "ProduÃ§Ã£o retomada" };
        var response = await Http.PatchAsJsonAsync($"api/ProductionOrders/{Id}/status", request);
        if (response.IsSuccessStatusCode)
        {
            ToastService.ShowToast(Portuguese.Msg_StatusUpdated, ToastLevel.Success);
            await LoadData();
        }
    }

    private async Task DownloadOrderReport(int id)
    {
        try
        {
            var response = await Http.GetAsync($"api/ProductionOrders/{id}/report");
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsByteArrayAsync();
                await JSRuntime.InvokeVoidAsync("downloadFile", $"Order_{id}.pdf", "application/pdf", content);
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowToast($"{Portuguese.Msg_Error}: {ex.Message}", ToastLevel.Error);
        }
    }

    private void GoBack() => NavigationManager.NavigateTo("/orders");

    private int GetStageIndex(string stage) => stage?.ToLower() switch
    {
        "cutting" => 0,
        "sewing" => 1,
        "review" => 2,
        "packaging" => 3,
        _ => 0
    };

    private bool IsRework => order != null && targetStage < GetStageIndex(order.CurrentStage);
    private bool CanSaveStageChange => !IsRework || !string.IsNullOrWhiteSpace(stageChangeNote);

    private async Task ChangeStage()
    {
        if (order == null) return;
        if (!CanSaveStageChange)
        {
             ToastService.ShowToast("ComentÃ¡rio Ã© obrigatÃ³rio para retrabalho.", ToastLevel.Warning);
             return;
        }

        try
        {
            isChangingStage = true;
            var request = new { NewStage = targetStage, Note = stageChangeNote };
            var response = await Http.PostAsJsonAsync($"api/ProductionOrders/{Id}/change-stage", request);

            if (response.IsSuccessStatusCode)
            {
                ToastService.ShowToast("EstÃ¡gio alterado com sucesso!", ToastLevel.Success);
                await LoadData();
            }
            else
            {
                ToastService.ShowToast($"Erro ao alterar estÃ¡gio.", ToastLevel.Error);
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowToast($"Erro: {ex.Message}", ToastLevel.Error);
        }
        finally
        {
            isChangingStage = false;
        }
    }

    private string GetStatusSoftClass(string? status) => status?.ToLower() switch
    {
        "completed" => "bg-success-soft",
        "inproduction" => "bg-primary-soft",
        "pending" => "bg-warning-soft",
        "stopped" or "paused" => "bg-danger-soft",
        _ => "bg-secondary"
    };

    [Inject] IJSRuntime JSRuntime { get; set; } = default!;
}
