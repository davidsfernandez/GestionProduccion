@page "/orders"
@using GestionProduccion.Client.Models.DTOs
@using GestionProduccion.Client.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Administrator,Leader,Operator")]
@inject HttpClient Http
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject SignalRService SignalR
@inject ToastService ToastService
@implements IAsyncDisposable

@using GestionProduccion.Client.Resources

<PageTitle>@Portuguese.OP_Title</PageTitle>

<div class="container-fluid p-0">
    <div class="mb-3">
        <h1 class="h3 d-inline align-middle">@Portuguese.OP_Title</h1>
        <div class="float-end">
            <AuthorizeView Roles="Administrator,Leader" Context="createContext">
                <button class="btn btn-primary" @onclick="CreateNewOrder">
                    <i class="align-middle" data-feather="plus"></i> <span class="align-middle">@Portuguese.OP_NewOrder</span>
                </button>
            </AuthorizeView>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0"><i class="align-middle" data-feather="search"></i></span>
                                <input type="text" class="form-control border-start-0" placeholder="@Portuguese.Search" 
                                       @bind="searchTerm" @bind:event="oninput" />
                            </div>
                        </div>
                        <div class="col-md-8 text-md-end mt-2 mt-md-0">
                            <button class="btn btn-light me-2" @onclick="ExportToCsv">
                                <i class="align-middle" data-feather="download"></i> @Portuguese.OP_ExportCSV
                            </button>
                            <AuthorizeView Roles="Administrator,Leader" Context="reportContext">
                                <button class="btn btn-light" @onclick="DownloadDailyReport">
                                    <i class="align-middle" data-feather="printer"></i> @Portuguese.OP_DailyPDF
                                </button>
                            </AuthorizeView>
                        </div>
                    </div>
                </div>
                
                @if (loading)
                {
                    <div class="card-body text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">@Portuguese.Loading</span>
                        </div>
                    </div>
                }
                else if (FilteredOrders == null || !FilteredOrders.Any())
                {
                    <div class="card-body">
                        <div class="alert alert-info mb-0">
                            @(string.IsNullOrEmpty(searchTerm) ? Portuguese.OP_NoOrdersFound : Portuguese.OP_NoOrdersMatch)
                        </div>
                    </div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-hover my-0">
                            <thead>
                                <tr>
                                    <th>@Portuguese.OP_Code</th>
                                    <th>@Portuguese.OP_Product</th>
                                    <th>@Portuguese.OP_Qty</th>
                                    <th>@Portuguese.OP_Stage</th>
                                    <th>@Portuguese.OP_Status</th>
                                    <th>@Portuguese.OP_Delivery</th>
                                    <th class="d-none d-md-table-cell">@Portuguese.OP_AssignedTo</th>
                                    <th class="text-end">@Portuguese.Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var order in FilteredOrders)
                                {
                                    <tr>
                                        <td><strong>@order.UniqueCode</strong></td>
                                        <td>@order.ProductDescription</td>
                                        <td>@order.Quantity</td>
                                        <td>
                                            <span class="badge bg-secondary">@TranslateStage(order.CurrentStage)</span>
                                        </td>
                                        <td>
                                            <span class="badge @GetStatusClass(order.CurrentStatus)">@TranslateStatus(order.CurrentStatus)</span>
                                        </td>
                                        <td>@order.EstimatedDeliveryDate.ToShortDateString()</td>
                                        <td class="d-none d-md-table-cell text-muted">@(order.AssignedUserName ?? Portuguese.OP_Unassigned)</td>
                                        <td class="text-end">
                                            <button class="btn btn-sm btn-light" @onclick="() => ViewDetails(order.Id)" title="@Portuguese.Details">
                                                <i class="align-middle" data-feather="eye"></i>
                                            </button>
                                            <button class="btn btn-sm btn-light text-danger" @onclick="() => DownloadOrderReport(order.Id)" title="@Portuguese.OP_Report">
                                                <i class="align-middle" data-feather="file-text"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    private List<ProductionOrderDto>? orders;
    private bool loading = true;
    private string searchTerm = "";

    private List<ProductionOrderDto>? FilteredOrders => string.IsNullOrWhiteSpace(searchTerm) 
        ? orders 
        : orders?.Where(o => o.UniqueCode.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) || 
                            o.ProductDescription.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)).ToList();

    protected override async Task OnInitializedAsync()
    {
        try 
        {
            var hubUrl = NavigationManager.ToAbsoluteUri("/productionHub").ToString();
            await SignalR.StartConnection(hubUrl);

            SignalR.OnUpdateReceived += async (opId, stage, status) => {
                await LoadOrders();
                await InvokeAsync(StateHasChanged);
            };
        }
        catch (Exception ex)
        {
            Console.WriteLine($"SignalR Error: {ex.Message}");
        }

        await LoadOrders();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender || !loading)
        {
            // Re-initialize Feather icons after render
            await JSRuntime.InvokeVoidAsync("feather.replace");
        }
    }

    private async Task LoadOrders()
    {
        try
        {
            loading = true;
            orders = await Http.GetFromJsonAsync<List<ProductionOrderDto>>("api/ProductionOrders");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading orders: {ex.Message}");
            orders = new List<ProductionOrderDto>();
        }
        finally
        {
            loading = false;
        }
    }

    private void CreateNewOrder() => NavigationManager.NavigateTo("/orders/create");
    private void ViewDetails(int id) => NavigationManager.NavigateTo($"/orders/{id}");

    private string TranslateStage(string? stage) => stage?.ToLower() switch
    {
        "cutting" => Portuguese.Stage_Cutting,
        "sewing" => Portuguese.Stage_Sewing,
        "review" => Portuguese.Stage_Review,
        "packaging" => Portuguese.Stage_Packaging,
        _ => stage ?? ""
    };

    private string TranslateStatus(string? status) => status?.ToLower() switch
    {
        "inproduction" => Portuguese.Status_InProduction,
        "stopped" => Portuguese.Status_Stopped,
        "completed" => Portuguese.Status_Completed,
        "paused" => Portuguese.Status_Paused,
        "finished" => Portuguese.Status_Finished,
        _ => status ?? ""
    };

    private async Task ExportToCsv()
    {
        if (orders == null || !orders.Any()) return;
        var csv = new System.Text.StringBuilder();
        csv.AppendLine($"{Portuguese.OP_Code},{Portuguese.OP_Product},{Portuguese.OP_Qty},{Portuguese.OP_Stage},{Portuguese.OP_Status},{Portuguese.OP_Delivery},{Portuguese.OP_AssignedTo}");
        foreach (var o in orders)
            csv.AppendLine($"{o.UniqueCode},{o.ProductDescription.Replace(",", " ")},{o.Quantity},{TranslateStage(o.CurrentStage)},{TranslateStatus(o.CurrentStatus)},{o.EstimatedDeliveryDate:yyyy-MM-dd},{o.AssignedUserName ?? Portuguese.OP_Unassigned}");
        
        await JSRuntime.InvokeVoidAsync("downloadCsv", $"Orders_{DateTime.Now:yyyyMMdd}.csv", csv.ToString());
        ToastService.ShowToast("CSV exportado com sucesso", ToastLevel.Info);
    }

    private async Task DownloadOrderReport(int id)
    {
        try
        {
            var response = await Http.GetAsync($"api/ProductionOrders/{id}/report");
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsByteArrayAsync();
                await JSRuntime.InvokeVoidAsync("downloadFile", $"Order_{id}.pdf", "application/pdf", content);
                ToastService.ShowToast(Portuguese.Msg_OrderUpdated, ToastLevel.Info);
            }
            else
            {
                ToastService.ShowToast(Portuguese.Msg_Error, ToastLevel.Error);
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowToast($"{Portuguese.Msg_Error}: {ex.Message}", ToastLevel.Error);
        }
    }

    private async Task DownloadDailyReport()
    {
        try
        {
            var response = await Http.GetAsync("api/ProductionOrders/daily-report");
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsByteArrayAsync();
                await JSRuntime.InvokeVoidAsync("downloadFile", $"DailyReport_{DateTime.Today:yyyyMMdd}.pdf", "application/pdf", content);
                ToastService.ShowToast(Portuguese.Success, ToastLevel.Info);
            }
            else
            {
                ToastService.ShowToast(Portuguese.Msg_Error, ToastLevel.Error);
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowToast($"{Portuguese.Msg_Error}: {ex.Message}", ToastLevel.Error);
        }
    }

    private string GetStatusClass(string? status) => status?.ToLower() switch
    {
        "completed" => "bg-success",
        "inproduction" => "bg-primary",
        "pending" => "bg-warning text-dark",
        "stopped" or "paused" => "bg-danger",
        _ => "bg-secondary"
    };

    public async ValueTask DisposeAsync()
    {
        try { await SignalR.StopConnection(); } catch { }
    }
}
