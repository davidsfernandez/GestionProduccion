@page "/orders"
@using GestionProduccion.Client.Models.DTOs
@using GestionProduccion.Client.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Administrator,Leader,Operator")]
@inject HttpClient Http
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject SignalRService SignalR
@inject ToastService ToastService
@implements IAsyncDisposable

@using GestionProduccion.Client.Resources

<PageTitle>@Portuguese.OP_Title</PageTitle>

<div class="container-fluid p-0">
    <div class="row mb-2 mb-xl-3">
        <div class="col-auto d-none d-sm-block">
            <h3 class="d-inline-block align-middle text-dark">@Portuguese.OP_Title</h3>
        </div>
        <div class="col-auto ms-auto text-end mt-n1">
            <AuthorizeView Roles="Administrator,Leader" Context="createContext">
                <button class="btn btn-primary shadow-sm" @onclick="CreateNewOrder">
                    <i class="fa-solid fa-plus me-2"></i> @Portuguese.OP_NewOrder
                </button>
            </AuthorizeView>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header border-0 pb-0">
                    <div class="row align-items-center">
                        <div class="col-md-12 mb-3">
                            <div class="input-group input-group-lg shadow-sm" style="border-radius: 12px; overflow: hidden;">
                                <span class="input-group-text bg-white border-0"><i class="fa-solid fa-magnifying-glass text-muted"></i></span>
                                <input type="search" class="form-control border-0 px-2" placeholder="Pesquisar por lote ou produto..."
                                       @bind="searchTerm" @bind:event="oninput" />
                            </div>
                        </div>
                        <div class="col-md-12 text-md-end mb-3 d-none d-md-block">
                            <button class="btn btn-light shadow-none border me-2" @onclick="ExportToCsv">
                                <i class="fa-solid fa-file-csv me-2"></i> @Portuguese.OP_ExportCSV
                            </button>
                            <AuthorizeView Roles="Administrator,Leader" Context="reportContext">
                                <button class="btn btn-light shadow-none border" @onclick="DownloadDailyReport">
                                    <i class="fa-solid fa-file-pdf me-2"></i> @Portuguese.OP_DailyPDF
                                </button>
                            </AuthorizeView>
                        </div>
                    </div>
                </div>

                @if (loading)
                {
                    <div class="card-body text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">@Portuguese.Loading</span>
                        </div>
                    </div>
                }
                else if (FilteredOrders == null || !FilteredOrders.Any())
                {
                    <div class="card-body">
                        <div class="alert alert-info mb-0 d-flex align-items-center">
                            <i class="fa-solid fa-circle-info me-2"></i>
                            <div>@(string.IsNullOrEmpty(searchTerm) ? Portuguese.OP_NoOrdersFound : Portuguese.OP_NoOrdersMatch)</div>
                        </div>
                    </div>
                }
                else
                {
                    @if (selectedOrderIds.Count > 0)
                    {
                        <div class="card-body bg-light border-bottom py-2">
                            <div class="d-flex align-items-center justify-content-between">
                                <span class="fw-bold text-primary">@selectedOrderIds.Count selecionado(s)</span>
                                <div>
                                    <button class="btn btn-sm btn-warning me-2 shadow-sm" @onclick="() => BulkUpdate(3)"> <!-- Paused -->
                                        <i class="fa-solid fa-pause me-1"></i> Pausar
                                    </button>
                                    <button class="btn btn-sm btn-success me-2 shadow-sm" @onclick="() => BulkUpdate(0)"> <!-- InProduction -->
                                        <i class="fa-solid fa-play me-1"></i> Retomar
                                    </button>
                                    <button class="btn btn-sm btn-danger shadow-sm" @onclick="() => BulkUpdate(1)"> <!-- Stopped -->
                                        <i class="fa-solid fa-stop me-1"></i> Parar
                                    </button>
                                </div>
                            </div>
                        </div>
                    }
                    <div class="table-mobile-responsive">
                        <table class="table table-hover my-0">
                            <thead>
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" class="form-check-input" @onchange="ToggleSelectAll" checked="@AllSelected" />
                                    </th>
                                    <th>@Portuguese.OP_Code</th>
                                    <th class="d-none d-md-table-cell">@Portuguese.OP_Product</th>
                                    <th class="d-none d-sm-table-cell">@Portuguese.OP_Qty</th>
                                    <th>@Portuguese.OP_Stage</th>
                                    <th>@Portuguese.OP_Status</th>
                                    <th class="d-none d-lg-table-cell">@Portuguese.OP_Delivery</th>
                                    <th class="d-none d-xl-table-cell">@Portuguese.OP_AssignedTo</th>
                                    <th class="text-end">@Portuguese.Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var order in FilteredOrders)
                                {
                                    <tr>
                                        <td>
                                            <input type="checkbox" class="form-check-input" checked="@selectedOrderIds.Contains(order.Id)" @onchange="@(() => ToggleSelection(order.Id))" @onclick:stopPropagation="true" />
                                        </td>
                                        <td><strong class="text-dark">@order.UniqueCode</strong></td>
                                        <td class="text-muted d-none d-md-table-cell">@order.ProductDescription</td>
                                        <td class="d-none d-sm-table-cell"><span class="fw-bold">@order.Quantity</span></td>
                                        <td>
                                            <span class="badge bg-light text-dark border">@TranslateStage(order.CurrentStage)</span>
                                        </td>
                                        <td>
                                            <span class="badge @GetStatusSoftClass(order.CurrentStatus)">
                                                @TranslateStatus(order.CurrentStatus)
                                            </span>
                                        </td>
                                        <td class="d-none d-lg-table-cell">@order.EstimatedDeliveryDate.ToString("dd/MM")</td>
                                        <td class="d-none d-xl-table-cell">
                                            <div class="d-flex align-items-center">
                                                <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 24px; height: 24px;">
                                                    <i class="fa-solid fa-user text-muted opacity-50" style="font-size: 0.7rem;"></i>
                                                </div>
                                                <span class="small text-muted">@(order.AssignedUserName ?? Portuguese.OP_Unassigned)</span>
                                            </div>
                                        </td>
                                        <td class="text-end">
                                            <button class="btn btn-lg btn-light me-1" @onclick="() => ViewDetails(order.Id)" title="@Portuguese.Details">
                                                <i class="fa-solid fa-eye"></i>
                                            </button>
                                            <button class="btn btn-lg btn-light text-danger" @onclick="() => DownloadOrderReport(order.Id)" title="@Portuguese.OP_Report">
                                                <i class="fa-solid fa-file-pdf"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<AuthorizeView Roles="Administrator,Leader">
    <button class="btn btn-primary btn-fab d-md-none" @onclick="CreateNewOrder">
        <i class="fa-solid fa-plus"></i>
    </button>
</AuthorizeView>

@code {
    private HashSet<int> selectedOrderIds = new();
    private List<ProductionOrderDto>? orders;
    private bool loading = true;
    private string searchTerm = "";

    private List<ProductionOrderDto>? FilteredOrders => string.IsNullOrWhiteSpace(searchTerm)
        ? orders
        : orders?.Where(o => o.UniqueCode.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                            o.ProductDescription.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)).ToList();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var hubUrl = NavigationManager.ToAbsoluteUri("/productionHub").ToString();
            await SignalR.StartConnection(hubUrl);

            SignalR.OnUpdateReceived += async (opId, stage, status) => {
                await LoadOrders();
                await InvokeAsync(StateHasChanged);
            };
        }
        catch (Exception ex)
        {
            Console.WriteLine($"SignalR Error: {ex.Message}");
        }

        await LoadOrders();
    }

    private async Task LoadOrders()
    {
        try
        {
            loading = true;
            orders = await Http.GetFromJsonAsync<List<ProductionOrderDto>>("api/ProductionOrders");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading orders: {ex.Message}");
            orders = new List<ProductionOrderDto>();
        }
        finally
        {
            loading = false;
        }
    }

    private void CreateNewOrder() => NavigationManager.NavigateTo("/orders/create");
    private void ViewDetails(int id) => NavigationManager.NavigateTo($"/orders/{id}");

    private string TranslateStage(string? stage) => stage?.ToLower() switch
    {
        "cutting" => Portuguese.Stage_Cutting,
        "sewing" => Portuguese.Stage_Sewing,
        "review" => Portuguese.Stage_Review,
        "packaging" => Portuguese.Stage_Packaging,
        _ => stage ?? ""
    };

    private string TranslateStatus(string? status) => status?.ToLower() switch
    {
        "inproduction" => Portuguese.Status_InProduction,
        "stopped" => Portuguese.Status_Stopped,
        "completed" => Portuguese.Status_Completed,
        "paused" => Portuguese.Status_Paused,
        "finished" => Portuguese.Status_Finished,
        _ => status ?? ""
    };

    private bool AllSelected => FilteredOrders != null && FilteredOrders.Any() && FilteredOrders.All(o => selectedOrderIds.Contains(o.Id));

    private void ToggleSelection(int id)
    {
        if (selectedOrderIds.Contains(id))
            selectedOrderIds.Remove(id);
        else
            selectedOrderIds.Add(id);
    }

    private void ToggleSelectAll(ChangeEventArgs e)
    {
        if (FilteredOrders == null) return;
        
        var isChecked = (bool)(e.Value ?? false);
        if (isChecked)
        {
            foreach (var order in FilteredOrders)
            {
                selectedOrderIds.Add(order.Id);
            }
        }
        else
        {
            selectedOrderIds.Clear();
        }
    }

    private async Task BulkUpdate(int status)
    {
        if (selectedOrderIds.Count == 0) return;
        
        try
        {
            loading = true;
            // Send request to backend
            var request = new { OrderIds = selectedOrderIds.ToList(), NewStatus = status, Note = "Atualização em massa via lista" };
            
            var response = await Http.PostAsJsonAsync("api/ProductionOrders/bulk-status", request);
            
            if (response.IsSuccessStatusCode)
            {
                ToastService.ShowToast($"{selectedOrderIds.Count} ordens atualizadas!", ToastLevel.Success);
                selectedOrderIds.Clear();
                await LoadOrders();
            }
            else
            {
                ToastService.ShowToast("Erro ao atualizar ordens.", ToastLevel.Error);
                loading = false; // Reset loading if not reloading
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowToast($"Erro: {ex.Message}", ToastLevel.Error);
            loading = false;
        }
    }

    private async Task ExportToCsv()
    {
        try 
        {
            ToastService.ShowToast("Gerando CSV...", ToastLevel.Info);
            var response = await Http.GetAsync("api/ProductionOrders/export-csv" + (string.IsNullOrWhiteSpace(searchTerm) ? "" : $"?productDescription={searchTerm}"));
            
            if (response.IsSuccessStatusCode)
            {
                var fileStream = await response.Content.ReadAsStreamAsync();
                using var streamRef = new DotNetStreamReference(stream: fileStream);
                await JSRuntime.InvokeVoidAsync("downloadFileFromStream", $"Orders_{DateTime.Now:yyyyMMdd}.csv", streamRef);
                ToastService.ShowToast("Download iniciado!", ToastLevel.Success);
            }
            else
            {
                ToastService.ShowToast("Erro ao exportar CSV", ToastLevel.Error);
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowToast($"Erro: {ex.Message}", ToastLevel.Error);
        }
    }

    private async Task DownloadOrderReport(int id)
    {
        try
        {
            var response = await Http.GetAsync($"api/ProductionOrders/{id}/report");
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsByteArrayAsync();
                await JSRuntime.InvokeVoidAsync("downloadFile", $"Order_{id}.pdf", "application/pdf", content);
                ToastService.ShowToast(Portuguese.Msg_OrderUpdated, ToastLevel.Info);
            }
            else
            {
                ToastService.ShowToast(Portuguese.Msg_Error, ToastLevel.Error);
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowToast($"{Portuguese.Msg_Error}: {ex.Message}", ToastLevel.Error);
        }
    }

    private async Task DownloadDailyReport()
    {
        try
        {
            var response = await Http.GetAsync("api/ProductionOrders/daily-report");
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsByteArrayAsync();
                await JSRuntime.InvokeVoidAsync("downloadFile", $"DailyReport_{DateTime.Today:yyyyMMdd}.pdf", "application/pdf", content);
                ToastService.ShowToast(Portuguese.Success, ToastLevel.Info);
            }
            else
            {
                ToastService.ShowToast(Portuguese.Msg_Error, ToastLevel.Error);
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowToast($"{Portuguese.Msg_Error}: {ex.Message}", ToastLevel.Error);
        }
    }

    private string GetStatusSoftClass(string? status) => status?.ToLower() switch
    {
        "completed" => "bg-success-soft",
        "inproduction" => "bg-primary-soft",
        "pending" => "bg-warning-soft",
        "stopped" or "paused" => "bg-danger-soft",
        _ => "bg-secondary"
    };

    public async ValueTask DisposeAsync()
    {
        try { await SignalR.StopConnection(); } catch { }
    }
}
