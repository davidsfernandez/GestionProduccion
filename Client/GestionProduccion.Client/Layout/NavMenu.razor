@using GestionProduccion.Client.Resources
@using Microsoft.AspNetCore.Components.Authorization
@using GestionProduccion.Client.Models.DTOs
@using System.Net.Http.Json
@inject AuthenticationStateProvider AuthStateProvider
@inject HttpClient Http
@inject GestionProduccion.Client.Services.UserStateService UserState
@implements IDisposable

<nav id="sidebar" class="sidebar js-sidebar @(IsOpen ? "toggled" : "")">
    <div class="sidebar-content js-simplebar">
        
        <!-- PERFIL EN SIDEBAR (Serona Standard) -->
        <AuthorizeView>
            <Authorized>
                <div class="sidebar-profile">
                    <div class="position-relative d-inline-block">
                        <img src="@(GetAvatarUrl())" class="profile-img" alt="Avatar" />
                        <div class="bg-primary position-absolute bottom-0 end-0 rounded-circle border border-dark" 
                             style="width: 14px; height: 14px; border-width: 2px !important;"></div>
                    </div>
                    <span class="profile-name">@(context.User.Identity?.Name ?? "Usuário")</span>
                    <span class="profile-role">
                        @TranslateRole(context.User.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value)
                    </span>
                </div>
            </Authorized>
            <NotAuthorized>
                <div class="sidebar-profile">
                    <div class="position-relative d-inline-block">
                        <img src="/img/avatars/avatar.jpg" class="profile-img" alt="Guest" />
                    </div>
                    <span class="profile-name">Convidado</span>
                    <span class="profile-role">Inicie sessão</span>
                </div>
            </NotAuthorized>
        </AuthorizeView>

        <ul class="sidebar-nav">
            <li class="menu-label">Principal</li>

            <li class="sidebar-item">
                <NavLink class="sidebar-link" href="" Match="NavLinkMatch.All">
                    <i class="fa-solid fa-house"></i> <span class="align-middle">@Portuguese.Nav_Dashboard</span>
                </NavLink>
            </li>

            <li class="sidebar-item">
                <NavLink class="sidebar-link" href="orders">
                    <i class="fa-solid fa-list-check"></i> <span class="align-middle">@Portuguese.Nav_Orders</span>
                </NavLink>
            </li>

            <li class="menu-label">Conta</li>

            <li class="sidebar-item">
                <NavLink class="sidebar-link" href="profile">
                    <i class="fa-solid fa-user-gear"></i> <span class="align-middle">@Portuguese.Nav_Profile</span>
                </NavLink>
            </li>

            <AuthorizeView Roles="Administrator">
                <li class="menu-label">Configurações</li>
                <li class="sidebar-item">
                    <NavLink class="sidebar-link" href="users">
                        <i class="fa-solid fa-users-gear"></i> <span class="align-middle">@Portuguese.Nav_Users</span>
                    </NavLink>
                </li>
            </AuthorizeView>
        </ul>
    </div>
</nav>

@code {
    private string GetAvatarUrl()
    {
        var url = UserState.AvatarUrl;
        if (string.IsNullOrEmpty(url))
        {
            return "/img/avatars/avatar.jpg";
        }
        // Ensure leading slash for consistency
        var finalUrl = url.StartsWith("/") ? url : "/" + url;
        return $"{finalUrl}?t={DateTime.Now.Ticks}";
    }

    protected override async Task OnInitializedAsync()
    {
        UserState.OnChange += NotifyStateChanged;
        AuthStateProvider.AuthenticationStateChanged += OnAuthStateChanged;
        await LoadUserData();
    }

    private async void NotifyStateChanged() => await InvokeAsync(StateHasChanged);

    private async void OnAuthStateChanged(Task<AuthenticationState> task)
    {
        await LoadUserData();
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadUserData()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var userIdClaim = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
            if (userIdClaim != null && int.TryParse(userIdClaim.Value, out int userId))
            {
                try
                {
                    var userDto = await Http.GetFromJsonAsync<UserDto>($"api/Users/{userId}");
                    if (userDto != null)
                    {
                        UserState.UpdateAvatar(userDto.AvatarUrl);
                    }
                }
                catch
                {
                    // Ignore errors, keep default avatar
                }
            }
        }
        else
        {
            UserState.UpdateAvatar(null);
        }
    }

    private string TranslateRole(string? role) => role?.ToLower() switch
    {
        "administrator" => Portuguese.Role_Admin,
        "leader" => Portuguese.Role_Leader,
        "operator" => Portuguese.Role_Operator,
        "sewer" => Portuguese.Role_Operator, // Map legacy role to current terminology
        "workshop" => Portuguese.Role_Workshop,
        _ => role ?? ""
    };

    public void Dispose()
    {
        UserState.OnChange -= NotifyStateChanged;
        AuthStateProvider.AuthenticationStateChanged -= OnAuthStateChanged;
    }

    [Parameter]
    public bool IsOpen { get; set; }
}
