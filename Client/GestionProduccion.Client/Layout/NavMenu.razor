@using GestionProduccion.Client.Resources

@using GestionProduccion.Client.Resources
@using Microsoft.AspNetCore.Components.Authorization
@using GestionProduccion.Client.Models.DTOs
@using System.Net.Http.Json
@inject AuthenticationStateProvider AuthStateProvider
@inject HttpClient Http
@implements IDisposable

<nav id="sidebar" class="sidebar js-sidebar">
    <div class="sidebar-content js-simplebar">
        
        <!-- PERFIL EN SIDEBAR (V2 Design) -->
        <AuthorizeView>
            <Authorized>
                <div class="sidebar-profile">
                    <div class="profile-img-container">
                        <img src="@(GetAvatarUrl())" class="profile-img" alt="Avatar" />
                        <div class="profile-badge"></div>
                    </div>
                    <span class="profile-name">@context.User.Identity?.Name</span>
                    <span class="profile-role">
                        @(context.User.IsInRole("Administrator") ? "Administrador" : "Usuario")
                    </span>
                </div>
            </Authorized>
            <NotAuthorized>
                <div class="sidebar-profile">
                    <div class="profile-img-container">
                        <img src="img/avatars/avatar.jpg" class="profile-img" alt="Guest" />
                    </div>
                    <span class="profile-name">Invitado</span>
                    <span class="profile-role">Por favor inicie sess√£o</span>
                </div>
            </NotAuthorized>
        </AuthorizeView>

        <ul class="sidebar-nav">
            <li class="menu-label">Principal</li>

            <li class="sidebar-item">
                <NavLink class="sidebar-link" href="" Match="NavLinkMatch.All">
                    <i class="fa-solid fa-gauge-high"></i> <span class="align-middle">@Portuguese.Nav_Dashboard</span>
                </NavLink>
            </li>

            <li class="sidebar-item">
                <NavLink class="sidebar-link" href="orders">
                    <i class="fa-solid fa-clipboard-list"></i> <span class="align-middle">@Portuguese.Nav_Orders</span>
                </NavLink>
            </li>

            <li class="menu-label">Conta</li>

            <li class="sidebar-item">
                <NavLink class="sidebar-link" href="profile">
                    <i class="fa-solid fa-user-gear"></i> <span class="align-middle">@Portuguese.Nav_Profile</span>
                </NavLink>
            </li>

            <AuthorizeView Roles="Administrator">
                <li class="menu-label">Admin</li>
                <li class="sidebar-item">
                    <NavLink class="sidebar-link" href="users">
                        <i class="fa-solid fa-users"></i> <span class="align-middle">@Portuguese.Nav_Users</span>
                    </NavLink>
                </li>
            </AuthorizeView>
        </ul>
    </div>
</nav>

@code {
    private string? avatarUrl;

    private string GetAvatarUrl()
    {
        if (string.IsNullOrEmpty(avatarUrl))
        {
            return "img/avatars/avatar.jpg";
        }
        return $"{avatarUrl}?t={DateTime.Now.Ticks}";
    }

    protected override async Task OnInitializedAsync()
    {
        AuthStateProvider.AuthenticationStateChanged += OnAuthStateChanged;
        await LoadUserData();
    }

    private async void OnAuthStateChanged(Task<AuthenticationState> task)
    {
        await LoadUserData();
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadUserData()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var userIdClaim = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
            if (userIdClaim != null && int.TryParse(userIdClaim.Value, out int userId))
            {
                try
                {
                    var userDto = await Http.GetFromJsonAsync<UserDto>($"api/Users/{userId}");
                    if (userDto != null)
                    {
                        avatarUrl = userDto.AvatarUrl;
                    }
                }
                catch
                {
                    // Ignore errors, keep default avatar
                }
            }
        }
        else
        {
            avatarUrl = null;
        }
    }

    public void Dispose()
    {
        AuthStateProvider.AuthenticationStateChanged -= OnAuthStateChanged;
    }
}