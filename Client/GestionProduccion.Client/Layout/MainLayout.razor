@inherits LayoutComponentBase
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@using GestionProduccion.Client.Auth
@using GestionProduccion.Client.Components
@using GestionProduccion.Client.Resources
@implements IDisposable

<div class="wrapper @(_sidebarOpen ? "sidebar-open" : "sidebar-closed")">
    <NavMenu IsOpen="_sidebarOpen" />

    <div class="main">
        <nav class="navbar navbar-expand navbar-light navbar-bg">
            <a class="sidebar-toggle js-sidebar-toggle" @onclick="ToggleSidebar">
                <i class="fa-solid fa-bars align-self-center" style="font-size: 1.5rem; color: #495057;"></i>
            </a>

            <div class="navbar-collapse collapse">
                <ul class="navbar-nav navbar-align ms-auto">
                    <AuthorizeView>
                        <Authorized>
                            <li class="nav-item">
                                <button class="btn btn-sm btn-outline-danger" @onclick="Logout">
                                    <i class="align-middle me-1" data-feather="log-out"></i> @Portuguese.Logout
                                </button>
                            </li>
                        </Authorized>
                        <NotAuthorized>
                            <li class="nav-item">
                                <a href="/login" class="btn btn-primary">@Portuguese.Login</a>
                            </li>
                        </NotAuthorized>
                    </AuthorizeView>
                </ul>
            </div>
        </nav>

        <main class="content">
            <div class="container-fluid p-0">
                <ToastContainer />
                @Body
            </div>
        </main>
    </div>

    @if (_sidebarOpen)
    {
        <div class="sidebar-overlay" @onclick="ToggleSidebar"></div>
    }
</div>

@code {
    private bool _sidebarOpen = false;

    protected override void OnInitialized()
    {
        NavigationManager.LocationChanged += OnLocationChanged;
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        // Close sidebar on navigation (Mobile UX)
        if (_sidebarOpen)
        {
            _sidebarOpen = false;
            StateHasChanged();
        }
    }

    private void ToggleSidebar()
    {
        _sidebarOpen = !_sidebarOpen;
    }

    private async Task Logout()
    {
        var customAuthStateProvider = (CustomAuthStateProvider)AuthStateProvider;
        await customAuthStateProvider.MarkUserAsLoggedOut();
        NavigationManager.NavigateTo("/login");
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
}