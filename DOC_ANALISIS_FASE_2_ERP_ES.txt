# Documento de Análisis y Diseño Técnico - Fase 2 ERP (Español)

## Módulo 1: Infraestructura y Autenticación
### Objetivos
1. **Login Persistente:** Uso de `LocalStorage` + Refresh Tokens.
2. **Recuperación de Contraseña:** Flujo seguro de tokens (Email/UI).
3. **Despliegue:** Scripts de instalación simplificados para Windows/IIS.

### Arquitectura de Datos (Adiciones)
- **PasswordResetToken:** (Id, UserId, TokenHash, ExpiryDate, IsUsed)
- **UserRefreshToken:** (Id, UserId, Token, ExpiryDate, DeviceInfo)

---

## Módulo 2: El Núcleo - Catálogo de SKUs
### Objetivos
- Migrar de texto simple a un catálogo relacional de productos y variaciones (SKUs).
- Implementar la "Memoria de Producción" para estimación automática de plazos.
- Generar Fichas de Producción técnicas con datos del producto y logotipo dinámico.

### Diseño Conceptual de Entidades
- **Producto:** Centro de la lógica (Nombre, Código, IdTejido, TiempoPromedioMóvil).
- **VarianteSKU:** Intersección de Producto, Talla y Color (CódigoSKU Único).
- **Tejido & Talla:** Tablas maestras de normalización.
- **ConfiguracionSistema:** Almacenamiento de "LogoEmpresa" y preferencias de UI.

### Lógica de Memoria Dinámica
- El sistema utiliza una **Media Móvil Ponderada**.
- Actualización automática al cerrar cada `ProductionOrder`.
- Impacto: Sugerencia automática de `Deadline` en nuevas órdenes basada en la capacidad del equipo asignado.

### Personalización
- Servicio de Configuración para inyectar el Logo en `MainLayout`.
- Soporte para Logo en reportes PDF de Fichas de Producción.

---

## Módulo 3: Visualización y Dashboard (BI)
### Objetivos
- **Modo TV (Floor Mode):** Monitoreo visual en tiempo real para la planta.
- **Dashboard Gerencial:** Panel ejecutivo con métricas de rentabilidad y eficiencia.
- **SignalR:** Notificaciones push para actualizaciones instantáneas.

### KPIs Estratégicos
- **Eficiencia:** (Tiempo Real vs Tiempo de Memoria de Producción).
- **Finanzas:** Costo medio por pieza, Margen medio, Modelos lucrativos.
- **Operaciones:** Producción por taller, Atrasos, Stock parado.

### Arquitectura de Componentes (Razor)
- **Modo TV:** `FloorLayout`, `ProductionSummaryCard`, `LiveOrdersTable`, `EfficiencyGauge`.
- **Dashboard:** `KpiGrid`, `ProductionChart`, `LucrativeModelsList`, `DiscontinueAlerts`.

### Diseño de Comunicación
- El servidor expone un `ProductionHub` para SignalR.
- El cliente Blazor mantiene un estado reactivo que se actualiza sin recargar la página.

---

## Módulo 5: Motor Financiero y Reporte de Lote
### Objetivos
- Cálculo automático de rentabilidad al finalizar cada lote.
- Generación de reportes PDF detallados (QuestPDF).
- Actualización de la "Memoria de Producción" con datos reales.

### Algoritmo de Costos
- **Costo Operativo Lote:** (Horas Netas Trabajadas * Tarifa Hora Configurada).
- **Costo Unitario Real:** Costo Lote / Cantidad Producida.
- **Análisis de Varianza:** Comparativa porcentual vs el promedio histórico del producto.

### Estructura del Reporte PDF
- **Cronograma:** Tiempos de inicio, fin y detalle de pausas justificadas.
- **Finanzas:** Desglose de costos y margen operativo.
- **Performance:** Indicadores de cumplimiento de plazos y comparación con la media.

---

## Módulo 4: Gestión Operativa, Tareas y Calidad
### Objetivos
- **Delegación de Tareas:** Actividades no relacionadas con costura (compras, logística).
- **Control de Calidad:** Registro de defectos por lote con evidencia fotográfica.
- **Usuario Operacional:** Notificaciones en tiempo real y barra de progreso de tiempo (SLA).

### Diseño Técnico
- **Calidad:** Compresión de fotos en cliente (Blazor Canvas API).
- **Ranking:** Puntos por cumplimiento de tareas en plazo.

---

## Módulo 6: Motor de Bonificación Dinámico
### Objetivos
- Automatizar el pago de comisiones colectivas por equipo (Equipe A, B).
- Motor de reglas configurables: Productividad, Plazo y Calidad.
- Generación de Recibos de Bonificación auditables para eliminar Excel.

### Lógica de Reglas
- **Filtro de Calidad:** Si los defectos superan el umbral (ej. 3%), el bono se anula.
- **Bono de Plazo:** Recompensa por entrega anticipada basada en el promedio histórico.

---

## Conclusión del Análisis de Fase 2
El sistema se consolida como un ERP integral que une la planta de producción con la gestión administrativa y financiera, garantizando trazabilidad, calidad y rentabilidad.
