# Diseño de Sprint 5: Motor Financiero y Reporte de Lote

## Objetivo
Implementar el cálculo de rentabilidad real mediante el motor de costos, el registro de pausas y la generación de reportes de cierre en PDF.

## Tareas Detalladas
1. **Control de Tiempos y Pausas:**
   - Entidad `ProductionPause` para registrar tiempos no productivos por lote.
   - UI para que el operario registre el motivo de la pausa (falta de insumos, descanso, falla técnica).

2. **Motor Financiero (Backend):**
   - `FinancialService`: Cálculo de costo total y unitario basado en tiempo neto y tarifa configurada.
   - Algoritmo de Varianza: Comparación de eficiencia real vs promedio histórico (Memoria).

3. **Cierre Atómico de Producción:**
   - Lógica de persistencia de resultados financieros al finalizar la orden.
   - Activador (Trigger) para actualizar el "Tiempo Promedio" del Producto en el catálogo.

4. **Generación de Reporte PDF (QuestPDF):**
   - Diseño de plantilla profesional con Logo Dinámico.
   - Inclusión de cronograma de trabajo, log de pausas y métricas de rentabilidad.

5. **BI Financiero (Dashboard):**
   - Integración de KPIs de margen y costo medio en el Dashboard Gerencial.
   - Gráficos de dispersión de costos por modelo de producto.

## Criterios de Aceptación
- El costo unitario descuenta correctamente el tiempo de pausas registradas.
- El reporte PDF es inmutable y refleja los datos del cierre exacto.
- La "Memoria de Producción" se ajusta automáticamente tras cada reporte de cierre.
- Los gráficos financieros del Dashboard muestran datos consolidados precisos.

Diseño del Sprint 2: Motor Financiero y Reporte de Lote

  Objetivo del Sprint:
  Implementar el motor de cálculo de costos reales, el sistema de registro de pausas y la generación automatizada de reportes de cierre de lote en
  formato PDF con análisis de performance.

  ---


  Tarea 5.1: Registro de Tiempos y Pausas (Data Layer)
   * Acción: Crear la infraestructura para medir el tiempo neto de trabajo.
   * Lógica:
       * Entidad ProductionPause: Registrará Motivo, HoraInicio y HoraFin.
       * Vincular las pausas a la ProductionOrder. Esto es crucial para restar el tiempo "no productivo" del cálculo del costo final.
   * Archivos implicados: Domain/Entities/ProductionPause.cs, Data/AppDbContext.cs.


  Tarea 5.2: Motor de Cálculo Financiero (Backend Service)
   * Acción: Desarrollar el servicio que determina la rentabilidad del lote.
   * Lógica:
       * FinancialService:
           * Obtener el CostoOperativoHora configurado para el taller.
           * Calcular el TiempoNeto = (Fin - Inicio) - Suma(Pausas).
           * CostoTotalLote = TiempoNeto * CostoHora.
           * CostoUnitarioReal = CostoTotalLote / CantidadBuenas.
       * Análisis de Varianza: Comparar el CostoUnitarioReal vs el CostoBase definido en el SKU (Sprint 2).
   * Archivos implicados: Services/FinancialService.cs, Models/DTOs/BatchCostResultDto.cs.


  Tarea 5.3: Transacción de Cierre de Lote
   * Acción: Implementar el proceso atómico de finalización de una orden.
   * Lógica:
       * Al cerrar el lote: 1. Persistir el BatchCostResult. 2. Disparar la actualización de la "Memoria de Producción" (Sprint 2). 3. Generar el 
         PDF de cierre. 4. Cambiar estado a Archivado/Finalizado.
   * Archivos implicados: Services/ProductionOrderService.cs (Refactorización).


  Tarea 5.4: Generador de Reporte PDF (QuestPDF Engine)
   * Acción: Diseñar el reporte oficial de fin de producción.
   * Requisitos del Reporte:
       * Cabecera con Logo Dinámico e ID de Lote.
       * Cronograma: Tabla de Inicio/Fin y detalle de cada pausa.
       * Finanzas: Desglose de costo total y costo por pieza.
       * Performance: Indicador visual si el lote estuvo "Dentro del promedio" o "Con retraso".
   * Archivos implicados: Services/PdfGeneratorService.cs, Templates/BatchReportTemplate.cs.


  Tarea 5.5: Integración con Dashboard BI
   * Acción: Alimentar las métricas de rentabilidad en el Dashboard del Sprint 3.
   * KPIs:
       * "Costo Medio por Pieza" (Mensual).
       * "Margen Medio por Producto".
       * "Top 5 Modelos más Lucrativos".
   * Archivos implicados: Services/AnalyticsService.cs (Ampliación).

  ---

  Estrategia de Validación (Criterios de Aceptación)
   1. Exactitud Matemática: El costo total del lote debe ser la multiplicación exacta de las horas netas (sin pausas) por la tarifa configurada.
   2. Inmutabilidad: Una vez cerrado el lote, los datos financieros no pueden ser alterados (Snapshotting).
   3. Calidad del PDF: El reporte debe generarse en menos de 3 segundos y ser legible para impresión.
   4. Retroalimentación: La "Memoria de Producción" del producto debe actualizarse inmediatamente después de generar el reporte de cierre.

  ---


  Archivos que se verán afectados o creados:
   - Domain/Entities/ProductionPause.cs (Nuevo)
   - Domain/Entities/BatchCostResult.cs (Nuevo)
   - Services/FinancialService.cs (Nuevo)
   - Templates/BatchReportTemplate.cs (Nuevo)
   - Services/PdfGeneratorService.cs (Modificación)
   - Client/Pages/Production/BatchSummary.razor (Nuevo)