# Docker Setup Script - GestionProduccion
# Interactive setup for first-time run
Write-Host "üöÄ Starting GestionProduccion Docker Setup..." -ForegroundColor Cyan

# 1. Check for .env file
$envFile = ".env"
if (!(Test-Path $envFile)) {
    Write-Host "üìù First time setup detected. Please configure your environment." -ForegroundColor Yellow
    
    # Prompt for Database Credentials
    $dbUser = Read-Host "Enter Database Username (default: gp_admin)"
    if ([string]::IsNullOrWhiteSpace($dbUser)) { $dbUser = "gp_admin" }

    $dbPass = Read-Host "Enter Database Password (default: secure_pass_123)"
    if ([string]::IsNullOrWhiteSpace($dbPass)) { $dbPass = "secure_pass_123" }

    $dbRootPass = Read-Host "Enter Database ROOT Password (default: root_secure_123)"
    if ([string]::IsNullOrWhiteSpace($dbRootPass)) { $dbRootPass = "root_secure_123" }

    # Generate Secure JWT Key
    $jwtKey = -join ((65..90) + (97..122) + (48..57) | Get-Random -Count 64 | % {[char]$_})
    Write-Host "üîë Generated secure JWT Key for this instance." -ForegroundColor Gray

    # Create .env content
    $envContent = @"
# Generated by run-docker.ps1
ASPNETCORE_ENVIRONMENT=Production
DB_DATABASE=GestionProduccionDB
DB_USER=$dbUser
DB_PASSWORD=$dbPass
DB_ROOT_PASSWORD=$dbRootPass
JWT_KEY=$jwtKey
JWT_ISSUER=GestionProduccion
JWT_AUDIENCE=GestionProduccionAPI
"@
    
    Set-Content -Path $envFile -Value $envContent
    Write-Host "‚úÖ Configuration saved to .env" -ForegroundColor Green
} else {
    Write-Host "‚úÖ Configuration found (.env). Using existing settings." -ForegroundColor Green
}

# 2. Check Docker
if (!(Get-Process docker -ErrorAction SilentlyContinue)) {
    Write-Host "‚ùå Error: Docker is not running. Please start Docker Desktop." -ForegroundColor Red
    exit 1
}

# 3. Build and Start
Write-Host "üê≥ Building and starting containers..." -ForegroundColor Cyan
docker-compose up -d --build

if ($LASTEXITCODE -eq 0) {
    Write-Host "`nüéâ SUCCESS! Application is running." -ForegroundColor Green
    Write-Host "üëâ App URL: http://localhost:8080" -ForegroundColor Cyan
    Write-Host "üëâ Database: Port 3307" -ForegroundColor Gray
    Write-Host "To stop: docker-compose down" -ForegroundColor Gray
} else {
    Write-Host "‚ùå Failed to start containers." -ForegroundColor Red
}
